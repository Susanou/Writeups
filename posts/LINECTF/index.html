<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="LINE CTF" /><meta property="og:locale" content="en_US" /><meta name="description" content="babycrypto1 Source code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 #!/usr/bin/env python from base64 import b64decode from base64 import b64encode import socket import multiprocessing from Crypto.Cipher import AES from Crypto.Random import get_random_bytes from Crypto.Util.Padding import pad, unpad import hashlib import sys class AESCipher: def __init__(self, key): self.key = key def encrypt(self, data): iv = get_random_bytes(AES.block_size) self.cipher = AES.new(self.key, AES.MODE_CBC, iv) return b64encode(iv + self.cipher.encrypt(pad(data, AES.block_size))) def encrypt_iv(self, data, iv): self.cipher = AES.new(self.key, AES.MODE_CBC, iv) return b64encode(iv + self.cipher.encrypt(pad(data, AES.block_size))) def decrypt(self, data): raw = b64decode(data) self.cipher = AES.new(self.key, AES.MODE_CBC, raw[:AES.block_size]) return unpad(self.cipher.decrypt(raw[AES.block_size:]), AES.block_size) flag = open(&quot;flag&quot;, &quot;rb&quot;).read().strip() COMMAND = [b&#39;test&#39;,b&#39;show&#39;] def run_server(client, aes_key, token): client.send(b&#39;test Command: &#39; + AESCipher(aes_key).encrypt(token+COMMAND[0]) + b&#39;\n&#39;) client.send(b&#39;**Cipher oracle**\n&#39;) client.send(b&#39;IV...: &#39;) iv = b64decode(client.recv(1024).decode().strip()) client.send(b&#39;Message...: &#39;) msg = b64decode(client.recv(1024).decode().strip()) client.send(b&#39;Ciphertext:&#39; + AESCipher(aes_key).encrypt_iv(msg,iv) + b&#39;\n\n&#39;) while(True): client.send(b&#39;Enter your command: &#39;) tt = client.recv(1024).strip() tt2 = AESCipher(aes_key).decrypt(tt) client.send(tt2 + b&#39;\n&#39;) if tt2 == token+COMMAND[1]: client.send(b&#39;The flag is: &#39; + flag) client.close() break if __name__ == &#39;__main__&#39;: server = socket.socket(socket.AF_INET, socket.SOCK_STREAM) server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) server.bind((&#39;0.0.0.0&#39;, 16001)) server.listen(1) while True: client, address = server.accept() aes_key = get_random_bytes(AES.block_size) token = b64encode(get_random_bytes(AES.block_size*10))[:AES.block_size*10] process = multiprocessing.Process(target=run_server, args=(client, aes_key, token)) process.daemon = True process.start() Solution Reading the source code, we can see that the idea is to replace the last block of encryption with show instead of test. In addition, the server allows us to encrypt a string with a given IV. When you look at the following diagram of AES_CBC decryption, you see that the last block is basically decrypted and then XORed with the previous block. So if we encrypt the string show with the previous block as the IV we would get the correct final block. Then we just need to replace that in the string that we were given at the start from the server and we can go ahead and send that to the serevr. Solution Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 from base64 import b64decode from base64 import b64encode from Crypto.Cipher import AES from Crypto.Random import get_random_bytes from Crypto.Util.Padding import pad, unpad from pwn import * import hashlib import sys r = remote(&quot;35.200.115.41&quot;, 16001, level=&#39;debug&#39;) line = str(r.recvline().replace(b&#39;\n&#39;, b&#39;&#39;)).split(&quot;: &quot;) r.recv() testcommand = line[1] iv = b64encode(b64decode(testcommand)[:16]) token = b64encode(b64decode(testcommand)[16:AES.block_size*10+16]) tokenlast = b64decode(token)[-16:] r.sendline(b64encode(tokenlast)) r.sendline(b64encode(b&#39;show&#39;)) line = str(r.recvline().replace(b&#39;\n&#39;, b&#39;&#39;)).split(&quot;:&quot;) encryptedshow = line[2] payload = b64encode(b64decode(iv)+b64decode(token)+b64decode(encryptedshow)[16:]) r.recvuntil(b&#39;Enter your command: &#39;) r.sendline(testcommand) r.recvuntil(b&#39;Enter your command: &#39;) r.sendline(payload) r.recv() r.recv() Rabbit Holes One thing that I kept doing was XORing show with the IV and the lastblock that have it work and send the IV at the start of the string sent by the server as the encryption IV but this didn’t work because show was XORed with the lastblock before encryption I also tried padding show to make it have the right length but that didn’t work because the data was additionally padded babycrypto2 Source Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 #!/usr/bin/env python from base64 import b64decode from base64 import b64encode import socket import multiprocessing from Crypto.Cipher import AES from Crypto.Random import get_random_bytes from Crypto.Util.Padding import pad, unpad import hashlib import sys class AESCipher: def __init__(self, key): self.key = key def encrypt(self, data): iv = get_random_bytes(AES.block_size) self.cipher = AES.new(self.key, AES.MODE_CBC, iv) return b64encode(iv + self.cipher.encrypt(pad(data, AES.block_size))) def encrypt_iv(self, data, iv): self.cipher = AES.new(self.key, AES.MODE_CBC, iv) return b64encode(iv + self.cipher.encrypt(pad(data, AES.block_size))) def decrypt(self, data): raw = b64decode(data) self.cipher = AES.new(self.key, AES.MODE_CBC, raw[:AES.block_size]) return unpad(self.cipher.decrypt(raw[AES.block_size:]), AES.block_size) flag = open(&quot;flag&quot;, &quot;rb&quot;).read().strip() AES_KEY = get_random_bytes(AES.block_size) TOKEN = b64encode(get_random_bytes(AES.block_size*10-1)) COMMAND = [b&#39;test&#39;,b&#39;show&#39;] PREFIX = b&#39;Command: &#39; def run_server(client): client.send(b&#39;test Command: &#39; + AESCipher(AES_KEY).encrypt(PREFIX+COMMAND[0]+TOKEN) + b&#39;\n&#39;) while(True): client.send(b&#39;Enter your command: &#39;) tt = client.recv(1024).strip() tt2 = AESCipher(AES_KEY).decrypt(tt) client.send(tt2 + b&#39;\n&#39;) if tt2 == PREFIX+COMMAND[1]+TOKEN: client.send(b&#39;The flag is: &#39; + flag) client.close() break if __name__ == &#39;__main__&#39;: server = socket.socket(socket.AF_INET, socket.SOCK_STREAM) server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) server.bind((&#39;0.0.0.0&#39;, 16002)) server.listen(1) while True: client, address = server.accept() process = multiprocessing.Process(target=run_server, args=(client, )) process.daemon = True process.start() Solution This challenge in my opinion was easier than the previous one. In this case the goal is to get the string to look like Command: show+token instead of Command: test+token. Again going back to our diagram, in this case we actually only need to modify the IV so that when it is XORed with the decrypted ciphertext it gives Command: show+token. Since we know that: [IV \oplus cipher = test] Thus we just need to do the following: [\Rightarrow IV \oplus cipher \oplus test \oplus show = test \oplus test \oplus show = show] Solution Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 from base64 import b64decode from base64 import b64encode from Crypto.Cipher import AES from Crypto.Random import get_random_bytes from Crypto.Util.Padding import pad, unpad from pwn import * import hashlib import sys r = remote(&quot;35.200.39.68&quot;, 16002, level=&#39;debug&#39;) line = str(r.recvline().replace(b&#39;\n&#39;, b&#39;&#39;)).split(&quot;: &quot;) testcommand = line[1] iv = b64decode(testcommand)[:16] payload = b64decode(testcommand)[16:] iv = iv[:9] + xor(xor(iv[9:13], b&#39;test&#39;), b&#39;show&#39;) + iv[13:] payload = b64encode(iv+payload) r.recvuntil(b&#39;Enter your command: &#39;) r.sendline(testcommand) r.recvuntil(b&#39;Enter your command: &#39;) r.sendline(payload) r.recv() r.recv() babycrypto3 We are given a pub.pem file. Load it into pycryptodome and we see that the bit length of n is very small so it can be factorized. Using msieve we get the two factors p and q of n. Later on the CTF, that was doable with RSACTFTool since a kindered soul decided to publish the factorization on factordb. We can then decrypt with the following: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 from Crypto.PublicKey import RSA from Crypto.Util.number import long_to_bytes, bytes_to_long from Crypto.Cipher import AES, PKCS1_OAEP from base64 import b64decode from base64 import b64encode with open(&#39;pvt.pem&#39;, &#39;r&#39;) as f: key = RSA.import_key(f.read()) with open(&#39;ciphertext.txt&#39;, &#39;rb&#39;) as f: cipher = bytes_to_long(f.read()) assert key.d == pow(key.e, -1, (key.p-1)*(key.q-1)) print(long_to_bytes(pow(cipher, key.d, key.n))) We get the following string 1 \x02`g\xff\x85\x1e\xcd\xcba\xe5\x0b\x83\xa5\x15\xe3\x00Q0xPU0lORyBUSEUgRElTVEFOQ0UuCg==\n We can see that there is some base64 at the end. When we decrypt that, we get something readble. Place that in the flag format and BINGO. 1 2 3 4 # decrypt the b64 at the end and put it in the flag format afterwards m = &quot;Q0xPU0lORyBUSEUgRElTVEFOQ0UuCg==&quot; print(b64decode(m)) # LINECTF{CLOSING THE DISTANCE.}" /><meta property="og:description" content="babycrypto1 Source code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 #!/usr/bin/env python from base64 import b64decode from base64 import b64encode import socket import multiprocessing from Crypto.Cipher import AES from Crypto.Random import get_random_bytes from Crypto.Util.Padding import pad, unpad import hashlib import sys class AESCipher: def __init__(self, key): self.key = key def encrypt(self, data): iv = get_random_bytes(AES.block_size) self.cipher = AES.new(self.key, AES.MODE_CBC, iv) return b64encode(iv + self.cipher.encrypt(pad(data, AES.block_size))) def encrypt_iv(self, data, iv): self.cipher = AES.new(self.key, AES.MODE_CBC, iv) return b64encode(iv + self.cipher.encrypt(pad(data, AES.block_size))) def decrypt(self, data): raw = b64decode(data) self.cipher = AES.new(self.key, AES.MODE_CBC, raw[:AES.block_size]) return unpad(self.cipher.decrypt(raw[AES.block_size:]), AES.block_size) flag = open(&quot;flag&quot;, &quot;rb&quot;).read().strip() COMMAND = [b&#39;test&#39;,b&#39;show&#39;] def run_server(client, aes_key, token): client.send(b&#39;test Command: &#39; + AESCipher(aes_key).encrypt(token+COMMAND[0]) + b&#39;\n&#39;) client.send(b&#39;**Cipher oracle**\n&#39;) client.send(b&#39;IV...: &#39;) iv = b64decode(client.recv(1024).decode().strip()) client.send(b&#39;Message...: &#39;) msg = b64decode(client.recv(1024).decode().strip()) client.send(b&#39;Ciphertext:&#39; + AESCipher(aes_key).encrypt_iv(msg,iv) + b&#39;\n\n&#39;) while(True): client.send(b&#39;Enter your command: &#39;) tt = client.recv(1024).strip() tt2 = AESCipher(aes_key).decrypt(tt) client.send(tt2 + b&#39;\n&#39;) if tt2 == token+COMMAND[1]: client.send(b&#39;The flag is: &#39; + flag) client.close() break if __name__ == &#39;__main__&#39;: server = socket.socket(socket.AF_INET, socket.SOCK_STREAM) server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) server.bind((&#39;0.0.0.0&#39;, 16001)) server.listen(1) while True: client, address = server.accept() aes_key = get_random_bytes(AES.block_size) token = b64encode(get_random_bytes(AES.block_size*10))[:AES.block_size*10] process = multiprocessing.Process(target=run_server, args=(client, aes_key, token)) process.daemon = True process.start() Solution Reading the source code, we can see that the idea is to replace the last block of encryption with show instead of test. In addition, the server allows us to encrypt a string with a given IV. When you look at the following diagram of AES_CBC decryption, you see that the last block is basically decrypted and then XORed with the previous block. So if we encrypt the string show with the previous block as the IV we would get the correct final block. Then we just need to replace that in the string that we were given at the start from the server and we can go ahead and send that to the serevr. Solution Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 from base64 import b64decode from base64 import b64encode from Crypto.Cipher import AES from Crypto.Random import get_random_bytes from Crypto.Util.Padding import pad, unpad from pwn import * import hashlib import sys r = remote(&quot;35.200.115.41&quot;, 16001, level=&#39;debug&#39;) line = str(r.recvline().replace(b&#39;\n&#39;, b&#39;&#39;)).split(&quot;: &quot;) r.recv() testcommand = line[1] iv = b64encode(b64decode(testcommand)[:16]) token = b64encode(b64decode(testcommand)[16:AES.block_size*10+16]) tokenlast = b64decode(token)[-16:] r.sendline(b64encode(tokenlast)) r.sendline(b64encode(b&#39;show&#39;)) line = str(r.recvline().replace(b&#39;\n&#39;, b&#39;&#39;)).split(&quot;:&quot;) encryptedshow = line[2] payload = b64encode(b64decode(iv)+b64decode(token)+b64decode(encryptedshow)[16:]) r.recvuntil(b&#39;Enter your command: &#39;) r.sendline(testcommand) r.recvuntil(b&#39;Enter your command: &#39;) r.sendline(payload) r.recv() r.recv() Rabbit Holes One thing that I kept doing was XORing show with the IV and the lastblock that have it work and send the IV at the start of the string sent by the server as the encryption IV but this didn’t work because show was XORed with the lastblock before encryption I also tried padding show to make it have the right length but that didn’t work because the data was additionally padded babycrypto2 Source Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 #!/usr/bin/env python from base64 import b64decode from base64 import b64encode import socket import multiprocessing from Crypto.Cipher import AES from Crypto.Random import get_random_bytes from Crypto.Util.Padding import pad, unpad import hashlib import sys class AESCipher: def __init__(self, key): self.key = key def encrypt(self, data): iv = get_random_bytes(AES.block_size) self.cipher = AES.new(self.key, AES.MODE_CBC, iv) return b64encode(iv + self.cipher.encrypt(pad(data, AES.block_size))) def encrypt_iv(self, data, iv): self.cipher = AES.new(self.key, AES.MODE_CBC, iv) return b64encode(iv + self.cipher.encrypt(pad(data, AES.block_size))) def decrypt(self, data): raw = b64decode(data) self.cipher = AES.new(self.key, AES.MODE_CBC, raw[:AES.block_size]) return unpad(self.cipher.decrypt(raw[AES.block_size:]), AES.block_size) flag = open(&quot;flag&quot;, &quot;rb&quot;).read().strip() AES_KEY = get_random_bytes(AES.block_size) TOKEN = b64encode(get_random_bytes(AES.block_size*10-1)) COMMAND = [b&#39;test&#39;,b&#39;show&#39;] PREFIX = b&#39;Command: &#39; def run_server(client): client.send(b&#39;test Command: &#39; + AESCipher(AES_KEY).encrypt(PREFIX+COMMAND[0]+TOKEN) + b&#39;\n&#39;) while(True): client.send(b&#39;Enter your command: &#39;) tt = client.recv(1024).strip() tt2 = AESCipher(AES_KEY).decrypt(tt) client.send(tt2 + b&#39;\n&#39;) if tt2 == PREFIX+COMMAND[1]+TOKEN: client.send(b&#39;The flag is: &#39; + flag) client.close() break if __name__ == &#39;__main__&#39;: server = socket.socket(socket.AF_INET, socket.SOCK_STREAM) server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) server.bind((&#39;0.0.0.0&#39;, 16002)) server.listen(1) while True: client, address = server.accept() process = multiprocessing.Process(target=run_server, args=(client, )) process.daemon = True process.start() Solution This challenge in my opinion was easier than the previous one. In this case the goal is to get the string to look like Command: show+token instead of Command: test+token. Again going back to our diagram, in this case we actually only need to modify the IV so that when it is XORed with the decrypted ciphertext it gives Command: show+token. Since we know that: [IV \oplus cipher = test] Thus we just need to do the following: [\Rightarrow IV \oplus cipher \oplus test \oplus show = test \oplus test \oplus show = show] Solution Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 from base64 import b64decode from base64 import b64encode from Crypto.Cipher import AES from Crypto.Random import get_random_bytes from Crypto.Util.Padding import pad, unpad from pwn import * import hashlib import sys r = remote(&quot;35.200.39.68&quot;, 16002, level=&#39;debug&#39;) line = str(r.recvline().replace(b&#39;\n&#39;, b&#39;&#39;)).split(&quot;: &quot;) testcommand = line[1] iv = b64decode(testcommand)[:16] payload = b64decode(testcommand)[16:] iv = iv[:9] + xor(xor(iv[9:13], b&#39;test&#39;), b&#39;show&#39;) + iv[13:] payload = b64encode(iv+payload) r.recvuntil(b&#39;Enter your command: &#39;) r.sendline(testcommand) r.recvuntil(b&#39;Enter your command: &#39;) r.sendline(payload) r.recv() r.recv() babycrypto3 We are given a pub.pem file. Load it into pycryptodome and we see that the bit length of n is very small so it can be factorized. Using msieve we get the two factors p and q of n. Later on the CTF, that was doable with RSACTFTool since a kindered soul decided to publish the factorization on factordb. We can then decrypt with the following: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 from Crypto.PublicKey import RSA from Crypto.Util.number import long_to_bytes, bytes_to_long from Crypto.Cipher import AES, PKCS1_OAEP from base64 import b64decode from base64 import b64encode with open(&#39;pvt.pem&#39;, &#39;r&#39;) as f: key = RSA.import_key(f.read()) with open(&#39;ciphertext.txt&#39;, &#39;rb&#39;) as f: cipher = bytes_to_long(f.read()) assert key.d == pow(key.e, -1, (key.p-1)*(key.q-1)) print(long_to_bytes(pow(cipher, key.d, key.n))) We get the following string 1 \x02`g\xff\x85\x1e\xcd\xcba\xe5\x0b\x83\xa5\x15\xe3\x00Q0xPU0lORyBUSEUgRElTVEFOQ0UuCg==\n We can see that there is some base64 at the end. When we decrypt that, we get something readble. Place that in the flag format and BINGO. 1 2 3 4 # decrypt the b64 at the end and put it in the flag format afterwards m = &quot;Q0xPU0lORyBUSEUgRElTVEFOQ0UuCg==&quot; print(b64decode(m)) # LINECTF{CLOSING THE DISTANCE.}" /><link rel="canonical" href="http://susanou.github.io/Writeups/posts/LINECTF/" /><meta property="og:url" content="http://susanou.github.io/Writeups/posts/LINECTF/" /><meta property="og:site_name" content="Writeups" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-03-20T23:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="LINE CTF" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-04-02T05:24:17+02:00","datePublished":"2021-03-20T23:00:00+01:00","description":"babycrypto1 Source code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 #!/usr/bin/env python from base64 import b64decode from base64 import b64encode import socket import multiprocessing from Crypto.Cipher import AES from Crypto.Random import get_random_bytes from Crypto.Util.Padding import pad, unpad import hashlib import sys class AESCipher: def __init__(self, key): self.key = key def encrypt(self, data): iv = get_random_bytes(AES.block_size) self.cipher = AES.new(self.key, AES.MODE_CBC, iv) return b64encode(iv + self.cipher.encrypt(pad(data, AES.block_size))) def encrypt_iv(self, data, iv): self.cipher = AES.new(self.key, AES.MODE_CBC, iv) return b64encode(iv + self.cipher.encrypt(pad(data, AES.block_size))) def decrypt(self, data): raw = b64decode(data) self.cipher = AES.new(self.key, AES.MODE_CBC, raw[:AES.block_size]) return unpad(self.cipher.decrypt(raw[AES.block_size:]), AES.block_size) flag = open(&quot;flag&quot;, &quot;rb&quot;).read().strip() COMMAND = [b&#39;test&#39;,b&#39;show&#39;] def run_server(client, aes_key, token): client.send(b&#39;test Command: &#39; + AESCipher(aes_key).encrypt(token+COMMAND[0]) + b&#39;\\n&#39;) client.send(b&#39;**Cipher oracle**\\n&#39;) client.send(b&#39;IV...: &#39;) iv = b64decode(client.recv(1024).decode().strip()) client.send(b&#39;Message...: &#39;) msg = b64decode(client.recv(1024).decode().strip()) client.send(b&#39;Ciphertext:&#39; + AESCipher(aes_key).encrypt_iv(msg,iv) + b&#39;\\n\\n&#39;) while(True): client.send(b&#39;Enter your command: &#39;) tt = client.recv(1024).strip() tt2 = AESCipher(aes_key).decrypt(tt) client.send(tt2 + b&#39;\\n&#39;) if tt2 == token+COMMAND[1]: client.send(b&#39;The flag is: &#39; + flag) client.close() break if __name__ == &#39;__main__&#39;: server = socket.socket(socket.AF_INET, socket.SOCK_STREAM) server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) server.bind((&#39;0.0.0.0&#39;, 16001)) server.listen(1) while True: client, address = server.accept() aes_key = get_random_bytes(AES.block_size) token = b64encode(get_random_bytes(AES.block_size*10))[:AES.block_size*10] process = multiprocessing.Process(target=run_server, args=(client, aes_key, token)) process.daemon = True process.start() Solution Reading the source code, we can see that the idea is to replace the last block of encryption with show instead of test. In addition, the server allows us to encrypt a string with a given IV. When you look at the following diagram of AES_CBC decryption, you see that the last block is basically decrypted and then XORed with the previous block. So if we encrypt the string show with the previous block as the IV we would get the correct final block. Then we just need to replace that in the string that we were given at the start from the server and we can go ahead and send that to the serevr. Solution Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 from base64 import b64decode from base64 import b64encode from Crypto.Cipher import AES from Crypto.Random import get_random_bytes from Crypto.Util.Padding import pad, unpad from pwn import * import hashlib import sys r = remote(&quot;35.200.115.41&quot;, 16001, level=&#39;debug&#39;) line = str(r.recvline().replace(b&#39;\\n&#39;, b&#39;&#39;)).split(&quot;: &quot;) r.recv() testcommand = line[1] iv = b64encode(b64decode(testcommand)[:16]) token = b64encode(b64decode(testcommand)[16:AES.block_size*10+16]) tokenlast = b64decode(token)[-16:] r.sendline(b64encode(tokenlast)) r.sendline(b64encode(b&#39;show&#39;)) line = str(r.recvline().replace(b&#39;\\n&#39;, b&#39;&#39;)).split(&quot;:&quot;) encryptedshow = line[2] payload = b64encode(b64decode(iv)+b64decode(token)+b64decode(encryptedshow)[16:]) r.recvuntil(b&#39;Enter your command: &#39;) r.sendline(testcommand) r.recvuntil(b&#39;Enter your command: &#39;) r.sendline(payload) r.recv() r.recv() Rabbit Holes One thing that I kept doing was XORing show with the IV and the lastblock that have it work and send the IV at the start of the string sent by the server as the encryption IV but this didn’t work because show was XORed with the lastblock before encryption I also tried padding show to make it have the right length but that didn’t work because the data was additionally padded babycrypto2 Source Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 #!/usr/bin/env python from base64 import b64decode from base64 import b64encode import socket import multiprocessing from Crypto.Cipher import AES from Crypto.Random import get_random_bytes from Crypto.Util.Padding import pad, unpad import hashlib import sys class AESCipher: def __init__(self, key): self.key = key def encrypt(self, data): iv = get_random_bytes(AES.block_size) self.cipher = AES.new(self.key, AES.MODE_CBC, iv) return b64encode(iv + self.cipher.encrypt(pad(data, AES.block_size))) def encrypt_iv(self, data, iv): self.cipher = AES.new(self.key, AES.MODE_CBC, iv) return b64encode(iv + self.cipher.encrypt(pad(data, AES.block_size))) def decrypt(self, data): raw = b64decode(data) self.cipher = AES.new(self.key, AES.MODE_CBC, raw[:AES.block_size]) return unpad(self.cipher.decrypt(raw[AES.block_size:]), AES.block_size) flag = open(&quot;flag&quot;, &quot;rb&quot;).read().strip() AES_KEY = get_random_bytes(AES.block_size) TOKEN = b64encode(get_random_bytes(AES.block_size*10-1)) COMMAND = [b&#39;test&#39;,b&#39;show&#39;] PREFIX = b&#39;Command: &#39; def run_server(client): client.send(b&#39;test Command: &#39; + AESCipher(AES_KEY).encrypt(PREFIX+COMMAND[0]+TOKEN) + b&#39;\\n&#39;) while(True): client.send(b&#39;Enter your command: &#39;) tt = client.recv(1024).strip() tt2 = AESCipher(AES_KEY).decrypt(tt) client.send(tt2 + b&#39;\\n&#39;) if tt2 == PREFIX+COMMAND[1]+TOKEN: client.send(b&#39;The flag is: &#39; + flag) client.close() break if __name__ == &#39;__main__&#39;: server = socket.socket(socket.AF_INET, socket.SOCK_STREAM) server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) server.bind((&#39;0.0.0.0&#39;, 16002)) server.listen(1) while True: client, address = server.accept() process = multiprocessing.Process(target=run_server, args=(client, )) process.daemon = True process.start() Solution This challenge in my opinion was easier than the previous one. In this case the goal is to get the string to look like Command: show+token instead of Command: test+token. Again going back to our diagram, in this case we actually only need to modify the IV so that when it is XORed with the decrypted ciphertext it gives Command: show+token. Since we know that: [IV \\oplus cipher = test] Thus we just need to do the following: [\\Rightarrow IV \\oplus cipher \\oplus test \\oplus show = test \\oplus test \\oplus show = show] Solution Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 from base64 import b64decode from base64 import b64encode from Crypto.Cipher import AES from Crypto.Random import get_random_bytes from Crypto.Util.Padding import pad, unpad from pwn import * import hashlib import sys r = remote(&quot;35.200.39.68&quot;, 16002, level=&#39;debug&#39;) line = str(r.recvline().replace(b&#39;\\n&#39;, b&#39;&#39;)).split(&quot;: &quot;) testcommand = line[1] iv = b64decode(testcommand)[:16] payload = b64decode(testcommand)[16:] iv = iv[:9] + xor(xor(iv[9:13], b&#39;test&#39;), b&#39;show&#39;) + iv[13:] payload = b64encode(iv+payload) r.recvuntil(b&#39;Enter your command: &#39;) r.sendline(testcommand) r.recvuntil(b&#39;Enter your command: &#39;) r.sendline(payload) r.recv() r.recv() babycrypto3 We are given a pub.pem file. Load it into pycryptodome and we see that the bit length of n is very small so it can be factorized. Using msieve we get the two factors p and q of n. Later on the CTF, that was doable with RSACTFTool since a kindered soul decided to publish the factorization on factordb. We can then decrypt with the following: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 from Crypto.PublicKey import RSA from Crypto.Util.number import long_to_bytes, bytes_to_long from Crypto.Cipher import AES, PKCS1_OAEP from base64 import b64decode from base64 import b64encode with open(&#39;pvt.pem&#39;, &#39;r&#39;) as f: key = RSA.import_key(f.read()) with open(&#39;ciphertext.txt&#39;, &#39;rb&#39;) as f: cipher = bytes_to_long(f.read()) assert key.d == pow(key.e, -1, (key.p-1)*(key.q-1)) print(long_to_bytes(pow(cipher, key.d, key.n))) We get the following string 1 \\x02`g\\xff\\x85\\x1e\\xcd\\xcba\\xe5\\x0b\\x83\\xa5\\x15\\xe3\\x00Q0xPU0lORyBUSEUgRElTVEFOQ0UuCg==\\n We can see that there is some base64 at the end. When we decrypt that, we get something readble. Place that in the flag format and BINGO. 1 2 3 4 # decrypt the b64 at the end and put it in the flag format afterwards m = &quot;Q0xPU0lORyBUSEUgRElTVEFOQ0UuCg==&quot; print(b64decode(m)) # LINECTF{CLOSING THE DISTANCE.}","headline":"LINE CTF","mainEntityOfPage":{"@type":"WebPage","@id":"http://susanou.github.io/Writeups/posts/LINECTF/"},"url":"http://susanou.github.io/Writeups/posts/LINECTF/"}</script><title>LINE CTF | Writeups</title><link rel="apple-touch-icon" sizes="180x180" href="/Writeups/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/Writeups/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/Writeups/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/Writeups/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/Writeups/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Writeups"><meta name="application-name" content="Writeups"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/Writeups/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/Writeups/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/Writeups/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script defer src="/Writeups/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/Writeups/" alt="avatar" class="mx-auto"> <img src="/Writeups/assets/img/sample/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/Writeups/">Writeups</a></div><div class="site-subtitle font-italic">Student by day Hacker by night</div></div><ul class="w-100"><li class="nav-item"> <a href="/Writeups/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/Writeups/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/Writeups/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/Writeups/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/Writeups/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Susanou" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://app.hackthebox.eu/profile/337512" aria-label="htb" target="_blank" rel="noopener"> <i class="fas fa-cube"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cam.hochberg','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/Writeups/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/cam-hochberg/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/Writeups/"> Posts </a> </span> <span>LINE CTF</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>LINE CTF</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Cameron Hochberg </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Mar 20, 2021, 11:00 PM +0100" prep="on" > Mar 20, 2021 <i class="unloaded">2021-03-20T23:00:00+01:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Apr 1, 2021, 11:24 PM -0400" prefix="Updated " > Apr 1, 2021 <i class="unloaded">2021-04-02T05:24:17+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1175 words">6 min</span></div></div><div class="post-content"><h1 id="babycrypto1">babycrypto1</h1><h2 id="source-code">Source code</h2><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python
</span><span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
<span class="kn">import</span> <span class="n">socket</span>
<span class="kn">import</span> <span class="n">multiprocessing</span>

<span class="kn">from</span> <span class="n">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="n">Crypto.Random</span> <span class="kn">import</span> <span class="n">get_random_bytes</span>
<span class="kn">from</span> <span class="n">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">unpad</span>
<span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="k">class</span> <span class="nc">AESCipher</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>

    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">iv</span> <span class="o">=</span> <span class="nf">get_random_bytes</span><span class="p">(</span><span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">b64encode</span><span class="p">(</span><span class="n">iv</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">cipher</span><span class="p">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nf">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> 
            <span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">encrypt_iv</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iv</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">b64encode</span><span class="p">(</span><span class="n">iv</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">cipher</span><span class="p">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nf">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> 
            <span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="nf">b64decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">raw</span><span class="p">[:</span><span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">])</span>
        <span class="k">return</span> <span class="nf">unpad</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cipher</span><span class="p">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">:]),</span> <span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">)</span>

<span class="n">flag</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">flag</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>

<span class="n">COMMAND</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">show</span><span class="sh">'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">run_server</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">aes_key</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="n">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">test Command: </span><span class="sh">'</span> <span class="o">+</span> <span class="nc">AESCipher</span><span class="p">(</span><span class="n">aes_key</span><span class="p">).</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">token</span><span class="o">+</span><span class="n">COMMAND</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">**Cipher oracle**</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">IV...: </span><span class="sh">'</span><span class="p">)</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="nf">b64decode</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="nf">decode</span><span class="p">().</span><span class="nf">strip</span><span class="p">())</span>
    <span class="n">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Message...: </span><span class="sh">'</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="nf">b64decode</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="nf">decode</span><span class="p">().</span><span class="nf">strip</span><span class="p">())</span>
    <span class="n">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Ciphertext:</span><span class="sh">'</span> <span class="o">+</span> <span class="nc">AESCipher</span><span class="p">(</span><span class="n">aes_key</span><span class="p">).</span><span class="nf">encrypt_iv</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="n">iv</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\n\n</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Enter your command: </span><span class="sh">'</span><span class="p">)</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
        <span class="n">tt2</span> <span class="o">=</span> <span class="nc">AESCipher</span><span class="p">(</span><span class="n">aes_key</span><span class="p">).</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
        <span class="n">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">tt2</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tt2</span> <span class="o">==</span> <span class="n">token</span><span class="o">+</span><span class="n">COMMAND</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">The flag is: </span><span class="sh">'</span> <span class="o">+</span> <span class="n">flag</span><span class="p">)</span>
            <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
            <span class="k">break</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="nf">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="nf">bind</span><span class="p">((</span><span class="sh">'</span><span class="s">0.0.0.0</span><span class="sh">'</span><span class="p">,</span> <span class="mi">16001</span><span class="p">))</span>
    <span class="n">server</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">client</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>

        <span class="n">aes_key</span> <span class="o">=</span> <span class="nf">get_random_bytes</span><span class="p">(</span><span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="nf">b64encode</span><span class="p">(</span><span class="nf">get_random_bytes</span><span class="p">(</span><span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="o">*</span><span class="mi">10</span><span class="p">))[:</span><span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="o">*</span><span class="mi">10</span><span class="p">]</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_server</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">aes_key</span><span class="p">,</span> <span class="n">token</span><span class="p">))</span>
        <span class="n">process</span><span class="p">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">process</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</pre></table></code></div></div><h2 id="solution">Solution</h2><p>Reading the source code, we can see that the idea is to replace the last block of encryption with <code class="language-plaintext highlighter-rouge">show</code> instead of <code class="language-plaintext highlighter-rouge">test</code>. In addition, the server allows us to encrypt a string with a given IV.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/Writeups/Writeups/assets/img/CTFImg/CBC_decryption.svg.png" alt="AES_decyption" /></p><p>When you look at the following diagram of AES_CBC decryption, you see that the last block is basically decrypted and then XORed with the previous block. So if we encrypt the string <code class="language-plaintext highlighter-rouge">show</code> with the previous block as the IV we would get the correct final block. Then we just need to replace that in the string that we were given at the start from the server and we can go ahead and send that to the serevr.</p><h3 id="solution-code">Solution Code</h3><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
<span class="kn">from</span> <span class="n">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="n">Crypto.Random</span> <span class="kn">import</span> <span class="n">get_random_bytes</span>
<span class="kn">from</span> <span class="n">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">unpad</span>

<span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="n">r</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">"</span><span class="s">35.200.115.41</span><span class="sh">"</span><span class="p">,</span> <span class="mi">16001</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="sh">'</span><span class="s">debug</span><span class="sh">'</span><span class="p">)</span>

<span class="n">line</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">recvline</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span> <span class="sa">b</span><span class="sh">''</span><span class="p">)).</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>

<span class="n">testcommand</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">iv</span> <span class="o">=</span> <span class="nf">b64encode</span><span class="p">(</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">testcommand</span><span class="p">)[:</span><span class="mi">16</span><span class="p">])</span>

<span class="n">token</span> <span class="o">=</span> <span class="nf">b64encode</span><span class="p">(</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">testcommand</span><span class="p">)[</span><span class="mi">16</span><span class="p">:</span><span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="mi">16</span><span class="p">])</span>
<span class="n">tokenlast</span> <span class="o">=</span> <span class="nf">b64decode</span><span class="p">(</span><span class="n">token</span><span class="p">)[</span><span class="o">-</span><span class="mi">16</span><span class="p">:]</span>
<span class="n">r</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">tokenlast</span><span class="p">))</span>

<span class="n">r</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="nf">b64encode</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">show</span><span class="sh">'</span><span class="p">))</span>
<span class="n">line</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">recvline</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span> <span class="sa">b</span><span class="sh">''</span><span class="p">)).</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">)</span>

<span class="n">encryptedshow</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">payload</span> <span class="o">=</span> <span class="nf">b64encode</span><span class="p">(</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span><span class="o">+</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="o">+</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">encryptedshow</span><span class="p">)[</span><span class="mi">16</span><span class="p">:])</span>
<span class="n">r</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Enter your command: </span><span class="sh">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">testcommand</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Enter your command: </span><span class="sh">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>
</pre></table></code></div></div><h2 id="rabbit-holes">Rabbit Holes</h2><ul><li>One thing that I kept doing was XORing <code class="language-plaintext highlighter-rouge">show</code> with the IV and the lastblock that have it work and send the IV at the start of the string sent by the server as the encryption IV but this didn’t work because <code class="language-plaintext highlighter-rouge">show</code> was XORed with the lastblock before encryption<li>I also tried padding <code class="language-plaintext highlighter-rouge">show</code> to make it have the right length but that didn’t work because the data was additionally padded</ul><h1 id="babycrypto2">babycrypto2</h1><h2 id="source-code-1">Source Code</h2><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python
</span><span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
<span class="kn">import</span> <span class="n">socket</span>
<span class="kn">import</span> <span class="n">multiprocessing</span>

<span class="kn">from</span> <span class="n">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="n">Crypto.Random</span> <span class="kn">import</span> <span class="n">get_random_bytes</span>
<span class="kn">from</span> <span class="n">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">unpad</span>
<span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="k">class</span> <span class="nc">AESCipher</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>

    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">iv</span> <span class="o">=</span> <span class="nf">get_random_bytes</span><span class="p">(</span><span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">b64encode</span><span class="p">(</span><span class="n">iv</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">cipher</span><span class="p">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nf">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> 
            <span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">encrypt_iv</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iv</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">b64encode</span><span class="p">(</span><span class="n">iv</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">cipher</span><span class="p">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nf">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> 
            <span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="nf">b64decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">raw</span><span class="p">[:</span><span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">])</span>
        <span class="k">return</span> <span class="nf">unpad</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">cipher</span><span class="p">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">:]),</span> <span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">)</span>

<span class="n">flag</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">flag</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">().</span><span class="nf">strip</span><span class="p">()</span>

<span class="n">AES_KEY</span> <span class="o">=</span> <span class="nf">get_random_bytes</span><span class="p">(</span><span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="p">)</span>
<span class="n">TOKEN</span> <span class="o">=</span> <span class="nf">b64encode</span><span class="p">(</span><span class="nf">get_random_bytes</span><span class="p">(</span><span class="n">AES</span><span class="p">.</span><span class="n">block_size</span><span class="o">*</span><span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">COMMAND</span> <span class="o">=</span> <span class="p">[</span><span class="sa">b</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="s">show</span><span class="sh">'</span><span class="p">]</span>
<span class="n">PREFIX</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">Command: </span><span class="sh">'</span>

<span class="k">def</span> <span class="nf">run_server</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">test Command: </span><span class="sh">'</span> <span class="o">+</span> <span class="nc">AESCipher</span><span class="p">(</span><span class="n">AES_KEY</span><span class="p">).</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">PREFIX</span><span class="o">+</span><span class="n">COMMAND</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">TOKEN</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Enter your command: </span><span class="sh">'</span><span class="p">)</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
        <span class="n">tt2</span> <span class="o">=</span> <span class="nc">AESCipher</span><span class="p">(</span><span class="n">AES_KEY</span><span class="p">).</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
        <span class="n">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">tt2</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tt2</span> <span class="o">==</span> <span class="n">PREFIX</span><span class="o">+</span><span class="n">COMMAND</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">TOKEN</span><span class="p">:</span>
            <span class="n">client</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">The flag is: </span><span class="sh">'</span> <span class="o">+</span> <span class="n">flag</span><span class="p">)</span>
            <span class="n">client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
            <span class="k">break</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="nf">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="nf">bind</span><span class="p">((</span><span class="sh">'</span><span class="s">0.0.0.0</span><span class="sh">'</span><span class="p">,</span> <span class="mi">16002</span><span class="p">))</span>
    <span class="n">server</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">client</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_server</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">process</span><span class="p">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">process</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
</pre></table></code></div></div><h2 id="solution-1">Solution</h2><p>This challenge in my opinion was easier than the previous one. In this case the goal is to get the string to look like <code class="language-plaintext highlighter-rouge">Command: show+token</code> instead of <code class="language-plaintext highlighter-rouge">Command: test+token</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/Writeups/Writeups/assets/img/CTFImg/CBC_decryption.svg.png" alt="AES_decyption" /></p><p>Again going back to our diagram, in this case we actually only need to modify the IV so that when it is XORed with the decrypted ciphertext it gives <code class="language-plaintext highlighter-rouge">Command: show+token</code>. Since we know that:</p>\[IV \oplus cipher = test\]<p>Thus we just need to do the following:</p>\[\Rightarrow IV \oplus cipher \oplus test \oplus show = test \oplus test \oplus show = show\]<h3 id="solution-code-1">Solution Code</h3><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
<span class="kn">from</span> <span class="n">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="n">Crypto.Random</span> <span class="kn">import</span> <span class="n">get_random_bytes</span>
<span class="kn">from</span> <span class="n">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">unpad</span>

<span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="n">hashlib</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="n">r</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">"</span><span class="s">35.200.39.68</span><span class="sh">"</span><span class="p">,</span> <span class="mi">16002</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="sh">'</span><span class="s">debug</span><span class="sh">'</span><span class="p">)</span>

<span class="n">line</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">recvline</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span> <span class="sa">b</span><span class="sh">''</span><span class="p">)).</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">: </span><span class="sh">"</span><span class="p">)</span>

<span class="n">testcommand</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">iv</span> <span class="o">=</span> <span class="nf">b64decode</span><span class="p">(</span><span class="n">testcommand</span><span class="p">)[:</span><span class="mi">16</span><span class="p">]</span>
<span class="n">payload</span> <span class="o">=</span> <span class="nf">b64decode</span><span class="p">(</span><span class="n">testcommand</span><span class="p">)[</span><span class="mi">16</span><span class="p">:]</span>

<span class="n">iv</span> <span class="o">=</span> <span class="n">iv</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="nf">xor</span><span class="p">(</span><span class="nf">xor</span><span class="p">(</span><span class="n">iv</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">13</span><span class="p">],</span> <span class="sa">b</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">),</span> <span class="sa">b</span><span class="sh">'</span><span class="s">show</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">iv</span><span class="p">[</span><span class="mi">13</span><span class="p">:]</span>

<span class="n">payload</span> <span class="o">=</span> <span class="nf">b64encode</span><span class="p">(</span><span class="n">iv</span><span class="o">+</span><span class="n">payload</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Enter your command: </span><span class="sh">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">testcommand</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">Enter your command: </span><span class="sh">'</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>
</pre></table></code></div></div><h1 id="babycrypto3">babycrypto3</h1><p>We are given a <code class="language-plaintext highlighter-rouge">pub.pem</code> file. Load it into pycryptodome and we see that the bit length of <code class="language-plaintext highlighter-rouge">n</code> is very small so it can be factorized. Using <code class="language-plaintext highlighter-rouge">msieve</code> we get the two factors <code class="language-plaintext highlighter-rouge">p</code> and <code class="language-plaintext highlighter-rouge">q</code> of <code class="language-plaintext highlighter-rouge">n</code>. Later on the CTF, that was doable with RSACTFTool since a kindered soul decided to publish the factorization on factordb. We can then decrypt with the following:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">Crypto.PublicKey</span> <span class="kn">import</span> <span class="n">RSA</span>
<span class="kn">from</span> <span class="n">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">long_to_bytes</span><span class="p">,</span> <span class="n">bytes_to_long</span>
<span class="kn">from</span> <span class="n">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span><span class="p">,</span> <span class="n">PKCS1_OAEP</span>
<span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>

<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">pvt.pem</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">RSA</span><span class="p">.</span><span class="nf">import_key</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">())</span>

<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">ciphertext.txt</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="nf">bytes_to_long</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">())</span>

<span class="k">assert</span> <span class="n">key</span><span class="p">.</span><span class="n">d</span> <span class="o">==</span> <span class="nf">pow</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">q</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">long_to_bytes</span><span class="p">(</span><span class="nf">pow</span><span class="p">(</span><span class="n">cipher</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">d</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">n</span><span class="p">)))</span>
</pre></table></code></div></div><p>We get the following string</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>\x02`g\xff\x85\x1e\xcd\xcba\xe5\x0b\x83\xa5\x15\xe3\x00Q0xPU0lORyBUSEUgRElTVEFOQ0UuCg==\n
</pre></table></code></div></div><p>We can see that there is some base64 at the end. When we decrypt that, we get something readble. Place that in the flag format and BINGO.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1"># decrypt the b64 at the end and put it in the flag format afterwards
</span><span class="n">m</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Q0xPU0lORyBUSEUgRElTVEFOQ0UuCg==</span><span class="sh">"</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
<span class="c1"># LINECTF{CLOSING THE DISTANCE.}
</span></pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/Writeups/categories/line-ctf/'>LINE CTF</a>, <a href='/Writeups/categories/cryptography/'>Cryptography</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/Writeups/tags/crypto/" class="post-tag no-text-decoration" >crypto</a> <a href="/Writeups/tags/rsa/" class="post-tag no-text-decoration" >RSA</a> <a href="/Writeups/tags/b64/" class="post-tag no-text-decoration" >b64</a> <a href="/Writeups/tags/aes/" class="post-tag no-text-decoration" >AES</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=LINE CTF - Writeups&url=http://susanou.github.io/Writeups/posts/LINECTF/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=LINE CTF - Writeups&u=http://susanou.github.io/Writeups/posts/LINECTF/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=LINE CTF - Writeups&url=http://susanou.github.io/Writeups/posts/LINECTF/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/Writeups/posts/cycling/">Cycling</a><li><a href="/Writeups/posts/mlsteal/">MLSteal</a><li><a href="/Writeups/posts/pythia/">Pythia</a><li><a href="/Writeups/posts/ChunkNoris/">Chunk Norris</a><li><a href="/Writeups/posts/Admirer/">Admirer</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/Writeups/tags/crypto/">crypto</a> <a class="post-tag" href="/Writeups/tags/rsa/">RSA</a> <a class="post-tag" href="/Writeups/tags/easy/">easy</a> <a class="post-tag" href="/Writeups/tags/web/">web</a> <a class="post-tag" href="/Writeups/tags/aes/">AES</a> <a class="post-tag" href="/Writeups/tags/linux/">linux</a> <a class="post-tag" href="/Writeups/tags/misc/">misc</a> <a class="post-tag" href="/Writeups/tags/mitm/">MITM</a> <a class="post-tag" href="/Writeups/tags/sqli/">SQLi</a> <a class="post-tag" href="/Writeups/tags/crt/">CRT</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/Writeups/posts/pythia/"><div class="card-body"> <span class="timeago small" > Jul 18, 2021 <i class="unloaded">2021-07-18T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Pythia</h3><div class="text-muted small"><p> Source Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 6...</p></div></div></a></div><div class="card"> <a href="/Writeups/posts/ChunkNoris/"><div class="card-body"> <span class="timeago small" > Aug 30, 2020 <i class="unloaded">2020-08-30T14:50:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Chunk Norris</h3><div class="text-muted small"><p> Chunk Norris (easy) Code given #!/usr/bin/python3 -u import random from Crypto.Util.number import * import gmpy2 a = 0xe64a5f84e2762be5 chunk_size = 64 def gen_prime(bits): s = random.getran...</p></div></div></a></div><div class="card"> <a href="/Writeups/posts/cycling/"><div class="card-body"> <span class="timeago small" > Jul 3, 2022 <i class="unloaded">2022-07-03T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Cycling</h3><div class="text-muted small"><p> Source code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 #!/usr/bin/python3 # Copyri...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/Writeups/posts/UnionCTF/" class="btn btn-outline-primary" prompt="Older"><p>Union CTF</p></a> <a href="/Writeups/posts/composition/" class="btn btn-outline-primary" prompt="Newer"><p>Composition</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/Writeups/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//writeups-fukurou.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'LINE CTF'; this.page.url = 'http://susanou.github.io/Writeups/posts/LINECTF/'; this.page.identifier = '/posts/LINECTF/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/Susanou">Cameron Hochberg</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="Susanou" data-description="Support me on Buy me a coffee!" data-message="" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18"></script></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/Writeups/tags/crypto/">crypto</a> <a class="post-tag" href="/Writeups/tags/rsa/">RSA</a> <a class="post-tag" href="/Writeups/tags/easy/">easy</a> <a class="post-tag" href="/Writeups/tags/web/">web</a> <a class="post-tag" href="/Writeups/tags/aes/">AES</a> <a class="post-tag" href="/Writeups/tags/linux/">linux</a> <a class="post-tag" href="/Writeups/tags/misc/">misc</a> <a class="post-tag" href="/Writeups/tags/mitm/">MITM</a> <a class="post-tag" href="/Writeups/tags/sqli/">SQLi</a> <a class="post-tag" href="/Writeups/tags/crt/">CRT</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/Writeups/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://susanou.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
