<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Pythia" /><meta property="og:locale" content="en_US" /><meta name="description" content="Source Code" /><meta property="og:description" content="Source Code" /><link rel="canonical" href="http://susanou.github.io/Writeups/posts/pythia/" /><meta property="og:url" content="http://susanou.github.io/Writeups/posts/pythia/" /><meta property="og:site_name" content="Writeups" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-07-18T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Pythia" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-07-21T00:30:17+02:00","datePublished":"2021-07-18T00:00:00+02:00","description":"Source Code","headline":"Pythia","mainEntityOfPage":{"@type":"WebPage","@id":"http://susanou.github.io/Writeups/posts/pythia/"},"url":"http://susanou.github.io/Writeups/posts/pythia/"}</script><title>Pythia | Writeups</title><link rel="apple-touch-icon" sizes="180x180" href="/Writeups/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/Writeups/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/Writeups/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/Writeups/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/Writeups/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Writeups"><meta name="application-name" content="Writeups"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/Writeups/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/Writeups/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/Writeups/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script defer src="/Writeups/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/Writeups/" alt="avatar" class="mx-auto"> <img src="/Writeups/assets/img/sample/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/Writeups/">Writeups</a></div><div class="site-subtitle font-italic">Student by day Hacker by night</div></div><ul class="w-100"><li class="nav-item"> <a href="/Writeups/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/Writeups/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/Writeups/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/Writeups/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/Writeups/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Susanou" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://app.hackthebox.eu/profile/337512" aria-label="htb" target="_blank" rel="noopener"> <i class="fas fa-cube"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cam.hochberg','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/Writeups/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/cam-hochberg/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/Writeups/"> Posts </a> </span> <span>Pythia</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Pythia</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Cameron Hochberg </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jul 18, 2021, 12:00 AM +0200" prep="on" > Jul 18, 2021 <i class="unloaded">2021-07-18T00:00:00+02:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Jul 20, 2021, 6:30 PM -0400" prefix="Updated " > Jul 20, 2021 <i class="unloaded">2021-07-21T00:30:17+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1605 words">8 min</span></div></div><div class="post-content"><h1 id="source-code">Source Code</h1><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python -u
</span><span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="n">string</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64encode</span><span class="p">,</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.primitives.ciphers.aead</span> <span class="kn">import</span> <span class="n">AESGCM</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.primitives.kdf.scrypt</span> <span class="kn">import</span> <span class="n">Scrypt</span>

<span class="n">max_queries</span> <span class="o">=</span> <span class="mi">150</span>
<span class="n">query_delay</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">passwords</span> <span class="o">=</span> <span class="p">[</span><span class="nf">bytes</span><span class="p">(</span><span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="sh">'</span><span class="s">UTF-8</span><span class="sh">'</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
<span class="n">flag</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">flag.txt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">rb</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">menu</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">What you wanna do?</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">1- Set key</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">2- Read flag</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">3- Decrypt text</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">4- Exit</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">int</span><span class="p">(</span><span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;&gt;&gt; </span><span class="sh">"</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Welcome!</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

<span class="n">key_used</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_queries</span><span class="p">):</span>
    <span class="n">option</span> <span class="o">=</span> <span class="nf">menu</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Which key you want to use [0-2]?</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;&gt;&gt; </span><span class="sh">"</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
          <span class="n">key_used</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Please select a valid key.</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Password?</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">passwd</span> <span class="o">=</span> <span class="nf">bytes</span><span class="p">(</span><span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;&gt;&gt; </span><span class="sh">"</span><span class="p">),</span> <span class="sh">'</span><span class="s">UTF-8</span><span class="sh">'</span><span class="p">)</span>

        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Checking...</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># Prevent bruteforce attacks...
</span>        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">query_delay</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">passwd</span> <span class="o">==</span> <span class="p">(</span><span class="n">passwords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">passwords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">passwords</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ACCESS GRANTED: </span><span class="sh">"</span> <span class="o">+</span> <span class="n">flag</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">UTF-8</span><span class="sh">'</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ACCESS DENIED!</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Send your ciphertext </span><span class="sh">"</span><span class="p">)</span>

        <span class="n">ct</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;&gt;&gt; </span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Decrypting...</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># Prevent bruteforce attacks...
</span>        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">query_delay</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nonce</span><span class="p">,</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">ct</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">nonce</span> <span class="o">=</span> <span class="nf">b64decode</span><span class="p">(</span><span class="n">nonce</span><span class="p">)</span>
            <span class="n">ciphertext</span> <span class="o">=</span> <span class="nf">b64decode</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ERROR: Ciphertext has invalid format. Must be of the form </span><span class="se">\"</span><span class="s">nonce,ciphertext</span><span class="se">\"</span><span class="s">, where nonce and ciphertext are base64 strings.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">kdf</span> <span class="o">=</span> <span class="nc">Scrypt</span><span class="p">(</span><span class="n">salt</span><span class="o">=</span><span class="sa">b</span><span class="sh">''</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="nf">default_backend</span><span class="p">())</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">kdf</span><span class="p">.</span><span class="nf">derive</span><span class="p">(</span><span class="n">passwords</span><span class="p">[</span><span class="n">key_used</span><span class="p">])</span> <span class="c1">#kdf.derive(passwords[key_used])
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">cipher</span> <span class="o">=</span> <span class="nc">AESGCM</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">plaintext</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">,</span> <span class="n">associated_data</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ERROR: Decryption failed. Key was not correct.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Decryption successful</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Bye!</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Invalid option!</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">You have </span><span class="sh">"</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="n">max_queries</span> <span class="o">-</span> <span class="n">query</span><span class="p">)</span> <span class="o">+</span> <span class="sh">"</span><span class="s"> trials left...</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
</pre></table></code></div></div><h1 id="solution">Solution</h1><p>After googling around, we found <a href="https://www.usenix.org/system/files/sec21summer_len.pdf">this paper</a> which detailed a way of recovering the key from AES GCM using repeating nonces.</p><p><em>PS: I will be using the notation the paper uses so check on section 3 in particular if you aren’t sure about the notation I use</em></p><h2 id="the-attack">The attack</h2><p>AES GCM works over <code class="language-plaintext highlighter-rouge">GF(2^128)</code> so all the operations work over that field.</p><p>One thing about AES GCM is that it is an Authenticated encryption with additional data (AEAD). In particular, GCM adds a tag at the end of of the ciphertext and computes it with the following equation:</p>\[T = C_1 \cdot H^{k-1} + ... + C_{k-1} \cdot H^2 + L \cdot H + E_K(N || 0^{31}1)\]<p>Where L is the length of the ciphertext. Each block of the cipher text <code class="language-plaintext highlighter-rouge">C_i</code> is essentially considered a coefficient of a polynomial under <code class="language-plaintext highlighter-rouge">GF(2^128)</code></p><p>The attack described consists in constructing a ciphertext and a tag from one nonce that is reused <code class="language-plaintext highlighter-rouge">N</code> and a set of keys <code class="language-plaintext highlighter-rouge">K</code>. Using this we can construct the following linear equation:</p>\[T = C_1 \cdot H^{k-1}_i + ... + C_{k-1} \cdot H^2_i + L \cdot H_i + E_{K_i}(N || 0^{31}1)\]<p>where \(H_i = E_{K_i}(0^n) = E_{K_i}(0^128)\)</p><p>and <code class="language-plaintext highlighter-rouge">H_i</code> is the associated GHASH to <code class="language-plaintext highlighter-rouge">key i</code></p><p>Since each <code class="language-plaintext highlighter-rouge">C_i</code> is a coefficient of a polynimial, we essentially have a polynomial of degree <code class="language-plaintext highlighter-rouge">k-1</code> on the left hand side. This results in a system of equation with k unkowns as follows</p>\[\begin{bmatrix} 1 &amp; H^2_1 &amp; H^3_1 &amp; \dotsb &amp; H_1^{k+1}\\ 1 &amp; H^2_2 &amp; H^3_2 &amp; \dotsb &amp; H_2^{k+1} \\ \vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots\\ 1 &amp; H^2_k &amp; H^3_k &amp; \dotsb &amp; H_k^{k+1} \end{bmatrix} \cdot \begin{bmatrix} T\\ C_{k-1}\\ \vdots\\ C_1 \end{bmatrix} = \begin{bmatrix} B_1\\ B_2\\ \vdots\\ B_k \end{bmatrix}\]<p>This is easily solvable using something like SAGEMATH for example.</p><h2 id="the-implementation">The Implementation</h2><p>The goal of the challenge is to recover 3 keys. To implement this attack, we do need to know the keyspace we are working with so that we can feed it or a slice of it to our collision function.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">passwords</span> <span class="o">=</span> <span class="p">[</span><span class="nf">bytes</span><span class="p">(</span><span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="sh">'</span><span class="s">UTF-8</span><span class="sh">'</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</pre></table></code></div></div><p>Thankfully, we are given this line which indicates that the 3 passwords can be chosen from the set of 3 lowercase letters ( more or less 17500 keys possible). Knowing this we can generate all possible keys before starting each collision:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span><span class="p">:</span>
            <span class="n">passwords</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="n">k</span><span class="p">)</span>

<span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">pw</span> <span class="ow">in</span> <span class="n">passwords</span><span class="p">:</span>
    <span class="c1">#print(pw)
</span>    <span class="n">kdf</span> <span class="o">=</span> <span class="nc">Scrypt</span><span class="p">(</span><span class="n">salt</span><span class="o">=</span><span class="sa">b</span><span class="sh">''</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="nf">default_backend</span><span class="p">())</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">kdf</span><span class="p">.</span><span class="nf">derive</span><span class="p">(</span><span class="n">pw</span><span class="p">.</span><span class="nf">encode</span><span class="p">())</span>
    <span class="c1">#print(key)
</span>    <span class="n">keys</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

</pre></table></code></div></div><p>The other problem we face is that we need to find said 3 keys in 150 queries or less:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">max_queries</span> <span class="o">=</span> <span class="mi">150</span>
<span class="c1">#--SNIP--
</span><span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">max_queries</span><span class="p">):</span>
</pre></table></code></div></div><p>For this we decided to do a binary search but we still needed to know what slice length to use. We decided to go for 1000 since there is about 17500 that gives us 18 queries at first in the worst case adn with recursive binary search it would take around 10 more queries at most to find the correct key. This leaves us short of the 150 queries max: PERFECT.</p><p>Our implementation took around 1min to generate collisions for a slice of 1000 keys so we decided to precompute all slices of 1000 keys and then compute the rest on the fly.</p><h1 id="solve-script">Solve script</h1><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">time</span>

<span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64encode</span><span class="p">,</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">bitstring</span> <span class="kn">import</span> <span class="n">BitArray</span>
<span class="kn">from</span> <span class="n">string</span> <span class="kn">import</span> <span class="n">ascii_lowercase</span>
<span class="kn">from</span> <span class="n">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.primitives.ciphers</span> <span class="kn">import</span> <span class="n">Cipher</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">modes</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.primitives.ciphers.aead</span> <span class="kn">import</span> <span class="n">AESGCM</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.primitives.kdf.scrypt</span> <span class="kn">import</span> <span class="n">Scrypt</span>
<span class="kn">from</span> <span class="n">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>

<span class="n">F</span><span class="p">.</span><span class="o">&lt;</span><span class="n">X</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nc">GF</span><span class="p">(</span><span class="mi">2</span><span class="p">)[]</span>
<span class="n">G</span><span class="p">.</span><span class="o">&lt;</span><span class="n">x</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nc">GF</span><span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">128</span><span class="p">,</span> <span class="n">modulus</span><span class="o">=</span><span class="n">X</span><span class="o">^</span><span class="mi">128</span> <span class="o">+</span> <span class="n">X</span><span class="o">^</span><span class="mi">7</span> <span class="o">+</span> <span class="n">X</span><span class="o">^</span><span class="mi">2</span> <span class="o">+</span> <span class="n">X</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">K</span><span class="p">.</span><span class="o">&lt;</span><span class="n">y</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">G</span><span class="p">[]</span>

<span class="n">passwords</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># passwords = [''.join(letters).encode() for letters in list(product(ascii_lowercase, repeat=3))]
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span><span class="p">:</span>
            <span class="n">passwords</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="n">k</span><span class="p">)</span>

<span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">pw</span> <span class="ow">in</span> <span class="n">passwords</span><span class="p">:</span>
    <span class="c1">#print(pw)
</span>    <span class="n">kdf</span> <span class="o">=</span> <span class="nc">Scrypt</span><span class="p">(</span><span class="n">salt</span><span class="o">=</span><span class="sa">b</span><span class="sh">''</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="nf">default_backend</span><span class="p">())</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">kdf</span><span class="p">.</span><span class="nf">derive</span><span class="p">(</span><span class="n">pw</span><span class="p">.</span><span class="nf">encode</span><span class="p">())</span>
    <span class="c1">#print(key)
</span>    <span class="n">keys</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">bytes_to_elt</span><span class="p">(</span><span class="n">in_bytes</span><span class="p">):</span>
    <span class="k">return</span> <span class="nc">G</span><span class="p">([</span><span class="nf">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nc">BitArray</span><span class="p">(</span><span class="n">in_bytes</span><span class="p">).</span><span class="nb">bin</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">collide</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
    <span class="n">L_bytes</span> <span class="o">=</span> <span class="nf">long_to_bytes</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">*</span> <span class="mi">128</span><span class="p">)</span>
    <span class="n">L_bytes</span> <span class="o">=</span> <span class="nf">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nf">len</span><span class="p">(</span><span class="n">L_bytes</span><span class="p">))</span> <span class="o">+</span> <span class="n">L_bytes</span>
    <span class="n">L</span> <span class="o">=</span> <span class="nf">bytes_to_elt</span><span class="p">(</span><span class="n">L_bytes</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="nf">bytes_to_elt</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="c1"># print(key)
</span>        <span class="c1"># print(type(key))
</span>        <span class="n">H_cipher</span> <span class="o">=</span> <span class="nc">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="p">.</span><span class="nc">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">modes</span><span class="p">.</span><span class="nc">ECB</span><span class="p">(),</span> <span class="n">backend</span><span class="o">=</span><span class="nf">default_backend</span><span class="p">())</span>
        <span class="n">H_encryptor</span> <span class="o">=</span> <span class="n">H_cipher</span><span class="p">.</span><span class="nf">encryptor</span><span class="p">()</span>
        <span class="n">H_bytes</span> <span class="o">=</span> <span class="n">H_encryptor</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="nf">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_encryptor</span><span class="p">.</span><span class="nf">finalize</span><span class="p">()</span>
        <span class="n">H</span> <span class="o">=</span> <span class="nf">bytes_to_elt</span><span class="p">(</span><span class="n">H_bytes</span><span class="p">)</span>

        <span class="n">P_cipher</span> <span class="o">=</span> <span class="nc">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="p">.</span><span class="nc">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">modes</span><span class="p">.</span><span class="nc">ECB</span><span class="p">(),</span> <span class="n">backend</span><span class="o">=</span><span class="nf">default_backend</span><span class="p">())</span>
        <span class="n">P_encryptor</span> <span class="o">=</span> <span class="n">P_cipher</span><span class="p">.</span><span class="nf">encryptor</span><span class="p">()</span>
        <span class="n">P_bytes</span> <span class="o">=</span> <span class="n">P_encryptor</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">nonce</span> <span class="o">+</span> <span class="nf">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="nf">bytes</span><span class="p">([</span><span class="mi">1</span><span class="p">]))</span> <span class="o">+</span> <span class="n">P_encryptor</span><span class="p">.</span><span class="nf">finalize</span><span class="p">()</span>
        <span class="n">P</span> <span class="o">=</span> <span class="nf">bytes_to_elt</span><span class="p">(</span><span class="n">P_bytes</span><span class="p">)</span>

        <span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">L</span> <span class="o">*</span> <span class="n">H</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span> <span class="o">+</span> <span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">H</span><span class="o">^</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pairs</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">K</span><span class="p">.</span><span class="nf">lagrange_polynomial</span><span class="p">(</span><span class="n">pairs</span><span class="p">).</span><span class="nf">list</span><span class="p">()</span>

    <span class="n">ciphertext</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
    <span class="k">for</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">coeffs</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">coeff</span><span class="p">.</span><span class="nf">polynomial</span><span class="p">().</span><span class="nf">list</span><span class="p">()</span>
        <span class="n">cc</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">128</span> <span class="o">-</span> <span class="nf">len</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span>
        <span class="n">ciphertext</span> <span class="o">+=</span> <span class="nc">BitArray</span><span class="p">(</span><span class="n">cc</span><span class="p">).</span><span class="nb">bytes</span>

    <span class="n">ciphertext</span> <span class="o">+=</span> <span class="nf">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">16</span>  <span class="c1"># tag at end
</span>
    <span class="k">return</span> <span class="n">ciphertext</span>

<span class="c1"># test it works
</span>
<span class="sh">"""</span><span class="s"> ciphertext = collide(keys[:3], bytes([0]) * 12, bytes([0]) * 16)
print(f</span><span class="sh">"</span><span class="s">[+] CT created: {ciphertext}</span><span class="sh">"</span><span class="s">)
cipher = AESGCM(keys[0])
plaintext = cipher.decrypt(bytes([0]) * 12, ciphertext, associated_data=None)
print(f</span><span class="sh">"</span><span class="s">[*]  decrypted PT: {plaintext}</span><span class="sh">"</span><span class="s">) </span><span class="sh">"""</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">keys</span><span class="p">))</span>
<span class="c1">#print(passwords[0])
</span>
<span class="c1"># ciphertext = collide(keys[:3], bytes([0]) * 12, bytes([0])*16)
</span>
<span class="c1"># print(b64encode(b'0'*12)+b','+b64encode(ciphertext))
</span>

<span class="k">def</span> <span class="nf">binary_search</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>

    <span class="n">pivot</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">end</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">pivot</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">[+] Creating collision ciphertext of slice keys[</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s">]</span><span class="sh">'</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">key type = </span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">start</span><span class="p">])</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">ciphertext</span> <span class="o">=</span> <span class="nf">collide</span><span class="p">([</span><span class="n">keys</span><span class="p">[</span><span class="n">start</span><span class="p">]],</span> <span class="nf">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">12</span><span class="p">,</span> <span class="nf">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">[-&gt;] Sending cipher text of slice keys[</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s">]</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;&gt; </span><span class="sh">'</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="nf">b64encode</span><span class="p">(</span><span class="nf">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="o">+</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;&gt; </span><span class="sh">'</span><span class="p">)</span>

        <span class="k">if</span> <span class="sa">b</span><span class="sh">'</span><span class="s">ERROR: Decryption failed. Key was not correct</span><span class="sh">'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[+] FOUND KEY: </span><span class="si">{</span><span class="n">passwords</span><span class="p">[</span><span class="n">start</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">start</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[+] FOUND KEY: </span><span class="si">{</span><span class="n">passwords</span><span class="p">[</span><span class="n">end</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">end</span>


    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">[+] Creating collision ciphertext of slice keys[</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">pivot</span><span class="si">}</span><span class="s">]</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">ciphertext</span> <span class="o">=</span> <span class="nf">collide</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">pivot</span><span class="p">],</span> <span class="nf">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">12</span><span class="p">,</span> <span class="nf">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">[-&gt;] Sending cipher text of slice keys[</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">pivot</span><span class="si">}</span><span class="s">]</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="nf">b64encode</span><span class="p">(</span><span class="nf">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="o">+</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;&gt; </span><span class="sh">'</span><span class="p">)</span>

    <span class="k">if</span> <span class="sa">b</span><span class="sh">'</span><span class="s">ERROR: Decryption failed. Key was not correct</span><span class="sh">'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">binary_search</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">pivot</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">binary_search</span><span class="p">(</span><span class="n">pivot</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

<span class="c1">#context.log_level = 'debug'
</span><span class="n">conn</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">'</span><span class="s">pythia.2021.ctfcompetition.com</span><span class="sh">'</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>


<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">ciphers.p</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">ciphers</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">key_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">conn</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;&gt; </span><span class="sh">'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">[+] Setting key to </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">j</span><span class="p">).</span><span class="nf">encode</span><span class="p">())</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;&gt; </span><span class="sh">'</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">[+] Creating collision ciphertext of slice keys[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1000</span><span class="si">}</span><span class="s">]</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">ciphers</span><span class="p">[</span><span class="n">i</span> <span class="o">//</span> <span class="mi">1000</span><span class="p">]</span> <span class="c1"># collide(keys[i:i+1000], bytes([0]) * 12, bytes([0])*16)
</span>        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">[-&gt;] Sending cipher text of slice keys[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1000</span><span class="si">}</span><span class="s">]</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;&gt; </span><span class="sh">'</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="nf">b64encode</span><span class="p">(</span><span class="nf">bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="o">+</span><span class="nf">b64encode</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">))</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;&gt; </span><span class="sh">'</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="sa">b</span><span class="sh">'</span><span class="s">ERROR: Decryption failed. Key was not correct</span><span class="sh">'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">key_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">passwords</span><span class="p">[</span><span class="nf">binary_search</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1000</span><span class="p">)].</span><span class="nf">encode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">))</span>
            <span class="k">break</span>

<span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">key_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="sa">b</span><span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">key_list</span><span class="p">))</span>
    <span class="n">stuff</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">&gt;&gt;&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">stuff</span><span class="p">)</span>

</pre></table></code></div></div><p><strong>FLAG:</strong> <code class="language-plaintext highlighter-rouge">CTF{gCm_1s_n0t_v3ry_r0bust_4nd_1_sh0uld_us3_s0m3th1ng_els3_h3r3}</code></p><h1 id="references">References</h1><ol><li><a href="https://www.usenix.org/system/files/sec21summer_len.pdf">https://www.usenix.org/system/files/sec21summer_len.pdf</a><li><a href="https://www.elttam.com/blog/key-recovery-attacks-on-gcm/">https://www.elttam.com/blog/key-recovery-attacks-on-gcm/</a><li><a href="https://eprint.iacr.org/2015/477.pdf">https://eprint.iacr.org/2015/477.pdf</a></ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/Writeups/categories/google-ctf-2021/'>Google CTF 2021</a>, <a href='/Writeups/categories/cryptography/'>Cryptography</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/Writeups/tags/crypto/" class="post-tag no-text-decoration" >crypto</a> <a href="/Writeups/tags/aes/" class="post-tag no-text-decoration" >AES</a> <a href="/Writeups/tags/gcm/" class="post-tag no-text-decoration" >GCM</a> <a href="/Writeups/tags/oracle/" class="post-tag no-text-decoration" >Oracle</a> <a href="/Writeups/tags/key-recovery/" class="post-tag no-text-decoration" >key recovery</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Pythia - Writeups&url=http://susanou.github.io/Writeups/posts/pythia/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Pythia - Writeups&u=http://susanou.github.io/Writeups/posts/pythia/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Pythia - Writeups&url=http://susanou.github.io/Writeups/posts/pythia/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/Writeups/posts/cycling/">Cycling</a><li><a href="/Writeups/posts/mlsteal/">MLSteal</a><li><a href="/Writeups/posts/pythia/">Pythia</a><li><a href="/Writeups/posts/ChunkNoris/">Chunk Norris</a><li><a href="/Writeups/posts/Admirer/">Admirer</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/Writeups/tags/crypto/">crypto</a> <a class="post-tag" href="/Writeups/tags/rsa/">RSA</a> <a class="post-tag" href="/Writeups/tags/easy/">easy</a> <a class="post-tag" href="/Writeups/tags/web/">web</a> <a class="post-tag" href="/Writeups/tags/aes/">AES</a> <a class="post-tag" href="/Writeups/tags/linux/">linux</a> <a class="post-tag" href="/Writeups/tags/misc/">misc</a> <a class="post-tag" href="/Writeups/tags/mitm/">MITM</a> <a class="post-tag" href="/Writeups/tags/sqli/">SQLi</a> <a class="post-tag" href="/Writeups/tags/crt/">CRT</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/Writeups/posts/LINECTF/"><div class="card-body"> <span class="timeago small" > Mar 20, 2021 <i class="unloaded">2021-03-20T23:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>LINE CTF</h3><div class="text-muted small"><p> babycrypto1 Source code #!/usr/bin/env python from base64 import b64decode from base64 import b64encode import socket import multiprocessing from Crypto.Cipher import AES from Crypto.Random impo...</p></div></div></a></div><div class="card"> <a href="/Writeups/posts/story/"><div class="card-body"> <span class="timeago small" > Jul 18, 2021 <i class="unloaded">2021-07-18T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Story</h3><div class="text-muted small"><p> Source code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 #!/usr/bin/env dart import 'dart:convert'; import 'dart:i...</p></div></div></a></div><div class="card"> <a href="/Writeups/posts/lazycbc/"><div class="card-body"> <span class="timeago small" > Jan 11, 2021 <i class="unloaded">2021-01-11T23:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Lazy CBC</h3><div class="text-muted small"><p></p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/Writeups/posts/static-client/" class="btn btn-outline-primary" prompt="Older"><p>Static Client</p></a> <a href="/Writeups/posts/story/" class="btn btn-outline-primary" prompt="Newer"><p>Story</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/Writeups/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//writeups-fukurou.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Pythia'; this.page.url = 'http://susanou.github.io/Writeups/posts/pythia/'; this.page.identifier = '/posts/pythia/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/Susanou">Cameron Hochberg</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="Susanou" data-description="Support me on Buy me a coffee!" data-message="" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18"></script></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/Writeups/tags/crypto/">crypto</a> <a class="post-tag" href="/Writeups/tags/rsa/">RSA</a> <a class="post-tag" href="/Writeups/tags/easy/">easy</a> <a class="post-tag" href="/Writeups/tags/web/">web</a> <a class="post-tag" href="/Writeups/tags/aes/">AES</a> <a class="post-tag" href="/Writeups/tags/linux/">linux</a> <a class="post-tag" href="/Writeups/tags/misc/">misc</a> <a class="post-tag" href="/Writeups/tags/mitm/">MITM</a> <a class="post-tag" href="/Writeups/tags/sqli/">SQLi</a> <a class="post-tag" href="/Writeups/tags/crt/">CRT</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/Writeups/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://susanou.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
