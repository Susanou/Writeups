<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Union CTF" /><meta property="og:locale" content="en_US" /><meta name="description" content="HumanServer Source Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 import os, random, hashlib, textwrap, json from Crypto.Cipher import AES from Crypto.Util.Padding import pad, unpad from Crypto.Util.number import getPrime, long_to_bytes from fastecdsa.curve import secp256k1 from fastecdsa.point import Point FLAG = b&#39;union{XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX}&#39; CURVE = secp256k1 ORDER = CURVE.q G = CURVE.G print(ORDER) class EllipticCurveKeyExchange(): def __init__(self): self.private = random.randint(0,ORDER) self.public = self.get_public_key() self.recieved = None self.nonce = None self.key = None def get_public_key(self): A = G * self.private return A def send_public(self): return print(json.dumps({&quot;Px&quot; : self.public.x, &quot;Py&quot; : self.public.y})) def receive_public(self, data): &quot;&quot;&quot; Remember to include the nonce for ultra-secure key exchange! &quot;&quot;&quot; Px = int(data[&quot;Px&quot;]) Py = int(data[&quot;Py&quot;]) self.recieved = Point(Px, Py, curve=secp256k1) self.nonce = int(data[&#39;nonce&#39;]) def get_shared_secret(self): &quot;&quot;&quot; Generates the ultra secure secret with added nonce randomness &quot;&quot;&quot; assert self.nonce.bit_length() &gt; 64 self.key = (self.recieved * self.private).x ^ self.nonce print(self.key) def check_fingerprint(self, h2: str): &quot;&quot;&quot; If this is failing, remember that you must send the SAME nonce to both Alice and Bob for the shared secret to match &quot;&quot;&quot; h1 = hashlib.sha256(long_to_bytes(self.key)).hexdigest() return h1 == h2 def send_fingerprint(self): return hashlib.sha256(long_to_bytes(self.key)).hexdigest() def print_header(title: str): print(&#39;\n\n&#39;+&#39;*&#39;*64+&#39;\n&#39;+&#39;*&#39;+title.center(62)+&#39;*\n&#39;+&#39;*&#39;*64+&#39;\n\n&#39;) def input_json(prompt: str): data = input(prompt) try: return json.loads(data) except: print({&quot;error&quot;: &quot;Input must be sent as a JSON object&quot;}) exit() def encrypt_flag(shared_secret: int): iv = os.urandom(16) key = hashlib.sha1(long_to_bytes(shared_secret)).digest()[:16] cipher = AES.new(key, AES.MODE_CBC, iv) ciphertext = cipher.encrypt(pad(FLAG, 16)) data = {} data[&#39;iv&#39;] = iv.hex() data[&#39;encrypted_flag&#39;] = ciphertext.hex() return print(json.dumps(data)) Alice = EllipticCurveKeyExchange() Bob = EllipticCurveKeyExchange() print_header(&#39;Welcome!&#39;) message = &quot;Hello! Thanks so much for jumping in to help. Ever since everyone left WhatsApp, we&#39;ve had a hard time keeping up with communications. We&#39;re hoping by outsourcing the message exchange to some CTF players we&#39;ll keep the load down on our servers... All messages are end-to-end encrypted so there&#39;s no privacy issues at all, we&#39;ve even rolling out our new ultra-secure key exchange with enhanced randomness! Again, we really appreciate the help, feel free to add this experience to your CV!&quot; welcome = textwrap.fill(message, width=64) print(welcome) print_header(&#39;Alice sends public key&#39;) Alice.send_public() print_header(&quot;Please forward Alice&#39;s key to Bob&quot;) alice_to_bob = input_json(&#39;Send to Bob: &#39;) Bob.receive_public(alice_to_bob) print_header(&#39;Bob sends public key&#39;) Bob.send_public() print_header(&quot;Please forward Bob&#39;s key to Alice&quot;) bob_to_alice = input_json(&#39;Send to Alice: &#39;) Alice.receive_public(bob_to_alice) Alice.get_shared_secret() Bob.get_shared_secret() print_header(&#39;Key verification in progress&#39;) alice_happy = Alice.check_fingerprint(Bob.send_fingerprint()) bob_happy = Bob.check_fingerprint(Alice.send_fingerprint()) if not alice_happy or not bob_happy: print({&quot;error&quot;: &quot;Alice and Bob panicked: Potential MITM attack in progress!!&quot;}) exit() print_header(&#39;Alice sends encrypted flag to Bob&#39;) encrypt_flag(Alice.key) Solution Here we are taking the role of an attacker in between Alice and Bob and we can modify the parameters that they send each other. The curve looks secure as well so we can’t really attack that. The interesting portion is the nonce that they use: 1 2 3 4 5 6 7 8 def get_shared_secret(self): &quot;&quot;&quot; Generates the ultra secure secret with added nonce randomness &quot;&quot;&quot; assert self.nonce.bit_length() &gt; 64 self.key = (self.recieved * self.private).x ^ self.nonce print(self.key) We can see here that they XOR the nonce with the shared key and check that they have the same shared key afterwards. To exploit that I went with the following approach: Use the generator of the curve as your key Send the point that was generated by Alice as the nonce to Bob and vice versa This means that we get the following [(a * G) \oplus B = A \oplus B] So now their shared key is basically A ^ B and we can then decrypt the flag with that Solution Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 import os, random, hashlib, textwrap, json from Crypto.Cipher import AES from Crypto.Util.Padding import pad, unpad from Crypto.Util.number import getPrime, long_to_bytes from pwn import * from fastecdsa.curve import secp256k1 from fastecdsa.point import Point r = remote(&#39;134.122.111.232&#39;, 54321, level=&#39;debug&#39;) def json_recv(): line = r.recvuntil(&quot;}&quot;) return json.loads(line.decode()) def json_send(hsh): request = json.dumps(hsh).encode() r.sendline(request) CURVE = secp256k1 ORDER = CURVE.q G = CURVE.G def get_public_key(private): A = G * private return A def get_nonce(private, received): r = Point(int(received[&quot;Px&quot;]), int(received[&quot;Py&quot;]), curve=secp256k1) return (r * private).x def decrypt_flag(shared_secret: int, iv: str, ciphertext: str): key = hashlib.sha1(long_to_bytes(shared_secret)).digest()[:16] cipher = AES.new(key, AES.MODE_CBC, bytes.fromhex(iv)) plaintext = cipher.decrypt(bytes.fromhex(ciphertext)) return unpad(plaintext, 16).decode() mykey = get_public_key(1) r.recvuntil(&quot;Alice sends public key&quot;) r.recv() Alice = json_recv() print(Alice) r.recvuntil(&quot;Send to Bob: &quot;) to_bob = { &quot;Px&quot;: mykey.x, &quot;Py&quot;: mykey.y, &quot;nonce&quot;: get_nonce(1, Alice) } json_send(to_bob) r.recvuntil(&quot;Bob sends public key&quot;) r.recv() Bob = json_recv() print(Bob) r.recvuntil(&quot;Send to Alice: &quot;) to_alice = { &quot;Px&quot;: mykey.x, &quot;Py&quot;: mykey.y, &quot;nonce&quot;: get_nonce(1, Bob) } json_send(to_alice) r.recvuntil(&quot;Alice sends encrypted flag to Bob&quot;) print(r.recvuntil(&quot;\n\n&quot;)) flag = json_recv() print(flag) shared = Alice[&quot;Px&quot;] ^ Bob[&quot;Px&quot;] print(decrypt_flag(shared, flag[&quot;iv&quot;], flag[&quot;encrypted_flag&quot;])) Mordel Primes Source Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 from Crypto.Util.number import bytes_to_long from secrets import k, FLAG assert k &lt; 2^128 assert FLAG.startswith(b&#39;union{&#39;) E = EllipticCurve(QQ,[0,1,0,78,-16]) P = E(1,8) Q = k*P R = (k+1)*P p = Q[0].numerator() q = R[0].numerator() assert is_prime(p) assert is_prime(q) e = 0x10001 N = p*q m = bytes_to_long(FLAG) c = pow(m,e,N) print(f&#39;N = {N}&#39;) print(f&#39;c = {c}&#39;) Solution Basically here the hint that was given weired me out. It said more or less that it could generate any prime number over the real numbers. This may be true but the way they are generated in the code above doesn’t guarantee a prime. So my guess was that k was small enough to brute force since they probably took only the first primes that worked and thats it. I brute forced this using SAGE and got the key k used pretty fast. Solution Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 import sys from Crypto.Util.number import bytes_to_long, long_to_bytes N = 5766655232619116707100300967885753418146107012385091223647868658490220759057780928028480463319202968587922648810849492353260432268633862603886585796452077987022107158189728686203729104591090970460014498552122526631361162547166873599979607915485144034921458475288775124782641916030643521973787176170306963637370313115151225986951445919112900996709332382715307195702225692083801566649385695837056673372362114813257496330084467265988611009917735012603399494099393876040942830547181089862217042482330353171767145579181573964386356108368535032006591008562456350857902266767781457374500922664326761246791942069022937125224604306624131848290329098431374262949684569694816299414596732546870156381228669433939793464357484350276549975208686778594644420026103742256946843249910774816227113354923539933217563489950555104589202554713352263020111530716888917819520339737690357308261622980951534684991840202859984869712892892239141756252277430937886738881996771080147445410272938947061294178392301438819956947795539940433827913212756666332943009775475701914578705703916156436662432161 c = 5724500982804393999552325992634045287952804319750892943470915970483096772331551016916840383945269998524761532882411398692955440900351993530895920241101091918876067020996223165561345416503911263094097500885104850313790954974285883830265883951377056590933470243828132977718861754767642606894660459919704238136774273318467087409260763141245595380917501542229644505850343679013926414725687233193424516852921591707704514884213118566638296775961963799700542015369513133068927399421907223126861526282761409972982821215039263330243890963476417099153704260378890644297771730781222451447236238246395881031433918137098089530325766260576207689592620432966551477624532170121304029721231233790374192012764855164589022421648544518425385200094885713570919714631967210149469074074462611116405014013224660911261571843297746613484477218466538991573759885491965661063156805466483257274481271612649728798486179280969505996944359268315985465229137237546375405105660181489587704128670445623442389570543693177429900841406620324743316472579871371203563098020011949005568574852024281173097996529 E = EllipticCurve(QQ,[0,1,0,78,-16]) P = E(1,8) k = 1 p1 = 0 # 17922287659013798442573402576339735849131128752056341575054197930940787246564949598938335376226031527888079106524104711777865485173232825060793232006924673971381527349154104858168561572160671487344179035618322434925270004055702274152607679042184080640691186862346789874863888075906696781653068925076057856953267732589112379785385330133335551948122941721689924982720304114154248001316403957518439002843731516224614663616879830159618638468356727817020281211416957107830839823313351269768071723444073187217264382241 while True: Q = k*P if is_prime(Q[0].numerator()): if N%Q[0].numerator() == 0: p1 = Q[0].numerator() break k+=1 # sys.stdout.write(k) q1 = N // p1 assert N == q1*p1 e = 0x10001 phi = (q1-1) * (p1-1) d = inverse_mod(e, phi) print(long_to_bytes(pow(c, d, N)))" /><meta property="og:description" content="HumanServer Source Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 import os, random, hashlib, textwrap, json from Crypto.Cipher import AES from Crypto.Util.Padding import pad, unpad from Crypto.Util.number import getPrime, long_to_bytes from fastecdsa.curve import secp256k1 from fastecdsa.point import Point FLAG = b&#39;union{XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX}&#39; CURVE = secp256k1 ORDER = CURVE.q G = CURVE.G print(ORDER) class EllipticCurveKeyExchange(): def __init__(self): self.private = random.randint(0,ORDER) self.public = self.get_public_key() self.recieved = None self.nonce = None self.key = None def get_public_key(self): A = G * self.private return A def send_public(self): return print(json.dumps({&quot;Px&quot; : self.public.x, &quot;Py&quot; : self.public.y})) def receive_public(self, data): &quot;&quot;&quot; Remember to include the nonce for ultra-secure key exchange! &quot;&quot;&quot; Px = int(data[&quot;Px&quot;]) Py = int(data[&quot;Py&quot;]) self.recieved = Point(Px, Py, curve=secp256k1) self.nonce = int(data[&#39;nonce&#39;]) def get_shared_secret(self): &quot;&quot;&quot; Generates the ultra secure secret with added nonce randomness &quot;&quot;&quot; assert self.nonce.bit_length() &gt; 64 self.key = (self.recieved * self.private).x ^ self.nonce print(self.key) def check_fingerprint(self, h2: str): &quot;&quot;&quot; If this is failing, remember that you must send the SAME nonce to both Alice and Bob for the shared secret to match &quot;&quot;&quot; h1 = hashlib.sha256(long_to_bytes(self.key)).hexdigest() return h1 == h2 def send_fingerprint(self): return hashlib.sha256(long_to_bytes(self.key)).hexdigest() def print_header(title: str): print(&#39;\n\n&#39;+&#39;*&#39;*64+&#39;\n&#39;+&#39;*&#39;+title.center(62)+&#39;*\n&#39;+&#39;*&#39;*64+&#39;\n\n&#39;) def input_json(prompt: str): data = input(prompt) try: return json.loads(data) except: print({&quot;error&quot;: &quot;Input must be sent as a JSON object&quot;}) exit() def encrypt_flag(shared_secret: int): iv = os.urandom(16) key = hashlib.sha1(long_to_bytes(shared_secret)).digest()[:16] cipher = AES.new(key, AES.MODE_CBC, iv) ciphertext = cipher.encrypt(pad(FLAG, 16)) data = {} data[&#39;iv&#39;] = iv.hex() data[&#39;encrypted_flag&#39;] = ciphertext.hex() return print(json.dumps(data)) Alice = EllipticCurveKeyExchange() Bob = EllipticCurveKeyExchange() print_header(&#39;Welcome!&#39;) message = &quot;Hello! Thanks so much for jumping in to help. Ever since everyone left WhatsApp, we&#39;ve had a hard time keeping up with communications. We&#39;re hoping by outsourcing the message exchange to some CTF players we&#39;ll keep the load down on our servers... All messages are end-to-end encrypted so there&#39;s no privacy issues at all, we&#39;ve even rolling out our new ultra-secure key exchange with enhanced randomness! Again, we really appreciate the help, feel free to add this experience to your CV!&quot; welcome = textwrap.fill(message, width=64) print(welcome) print_header(&#39;Alice sends public key&#39;) Alice.send_public() print_header(&quot;Please forward Alice&#39;s key to Bob&quot;) alice_to_bob = input_json(&#39;Send to Bob: &#39;) Bob.receive_public(alice_to_bob) print_header(&#39;Bob sends public key&#39;) Bob.send_public() print_header(&quot;Please forward Bob&#39;s key to Alice&quot;) bob_to_alice = input_json(&#39;Send to Alice: &#39;) Alice.receive_public(bob_to_alice) Alice.get_shared_secret() Bob.get_shared_secret() print_header(&#39;Key verification in progress&#39;) alice_happy = Alice.check_fingerprint(Bob.send_fingerprint()) bob_happy = Bob.check_fingerprint(Alice.send_fingerprint()) if not alice_happy or not bob_happy: print({&quot;error&quot;: &quot;Alice and Bob panicked: Potential MITM attack in progress!!&quot;}) exit() print_header(&#39;Alice sends encrypted flag to Bob&#39;) encrypt_flag(Alice.key) Solution Here we are taking the role of an attacker in between Alice and Bob and we can modify the parameters that they send each other. The curve looks secure as well so we can’t really attack that. The interesting portion is the nonce that they use: 1 2 3 4 5 6 7 8 def get_shared_secret(self): &quot;&quot;&quot; Generates the ultra secure secret with added nonce randomness &quot;&quot;&quot; assert self.nonce.bit_length() &gt; 64 self.key = (self.recieved * self.private).x ^ self.nonce print(self.key) We can see here that they XOR the nonce with the shared key and check that they have the same shared key afterwards. To exploit that I went with the following approach: Use the generator of the curve as your key Send the point that was generated by Alice as the nonce to Bob and vice versa This means that we get the following [(a * G) \oplus B = A \oplus B] So now their shared key is basically A ^ B and we can then decrypt the flag with that Solution Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 import os, random, hashlib, textwrap, json from Crypto.Cipher import AES from Crypto.Util.Padding import pad, unpad from Crypto.Util.number import getPrime, long_to_bytes from pwn import * from fastecdsa.curve import secp256k1 from fastecdsa.point import Point r = remote(&#39;134.122.111.232&#39;, 54321, level=&#39;debug&#39;) def json_recv(): line = r.recvuntil(&quot;}&quot;) return json.loads(line.decode()) def json_send(hsh): request = json.dumps(hsh).encode() r.sendline(request) CURVE = secp256k1 ORDER = CURVE.q G = CURVE.G def get_public_key(private): A = G * private return A def get_nonce(private, received): r = Point(int(received[&quot;Px&quot;]), int(received[&quot;Py&quot;]), curve=secp256k1) return (r * private).x def decrypt_flag(shared_secret: int, iv: str, ciphertext: str): key = hashlib.sha1(long_to_bytes(shared_secret)).digest()[:16] cipher = AES.new(key, AES.MODE_CBC, bytes.fromhex(iv)) plaintext = cipher.decrypt(bytes.fromhex(ciphertext)) return unpad(plaintext, 16).decode() mykey = get_public_key(1) r.recvuntil(&quot;Alice sends public key&quot;) r.recv() Alice = json_recv() print(Alice) r.recvuntil(&quot;Send to Bob: &quot;) to_bob = { &quot;Px&quot;: mykey.x, &quot;Py&quot;: mykey.y, &quot;nonce&quot;: get_nonce(1, Alice) } json_send(to_bob) r.recvuntil(&quot;Bob sends public key&quot;) r.recv() Bob = json_recv() print(Bob) r.recvuntil(&quot;Send to Alice: &quot;) to_alice = { &quot;Px&quot;: mykey.x, &quot;Py&quot;: mykey.y, &quot;nonce&quot;: get_nonce(1, Bob) } json_send(to_alice) r.recvuntil(&quot;Alice sends encrypted flag to Bob&quot;) print(r.recvuntil(&quot;\n\n&quot;)) flag = json_recv() print(flag) shared = Alice[&quot;Px&quot;] ^ Bob[&quot;Px&quot;] print(decrypt_flag(shared, flag[&quot;iv&quot;], flag[&quot;encrypted_flag&quot;])) Mordel Primes Source Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 from Crypto.Util.number import bytes_to_long from secrets import k, FLAG assert k &lt; 2^128 assert FLAG.startswith(b&#39;union{&#39;) E = EllipticCurve(QQ,[0,1,0,78,-16]) P = E(1,8) Q = k*P R = (k+1)*P p = Q[0].numerator() q = R[0].numerator() assert is_prime(p) assert is_prime(q) e = 0x10001 N = p*q m = bytes_to_long(FLAG) c = pow(m,e,N) print(f&#39;N = {N}&#39;) print(f&#39;c = {c}&#39;) Solution Basically here the hint that was given weired me out. It said more or less that it could generate any prime number over the real numbers. This may be true but the way they are generated in the code above doesn’t guarantee a prime. So my guess was that k was small enough to brute force since they probably took only the first primes that worked and thats it. I brute forced this using SAGE and got the key k used pretty fast. Solution Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 import sys from Crypto.Util.number import bytes_to_long, long_to_bytes N = 5766655232619116707100300967885753418146107012385091223647868658490220759057780928028480463319202968587922648810849492353260432268633862603886585796452077987022107158189728686203729104591090970460014498552122526631361162547166873599979607915485144034921458475288775124782641916030643521973787176170306963637370313115151225986951445919112900996709332382715307195702225692083801566649385695837056673372362114813257496330084467265988611009917735012603399494099393876040942830547181089862217042482330353171767145579181573964386356108368535032006591008562456350857902266767781457374500922664326761246791942069022937125224604306624131848290329098431374262949684569694816299414596732546870156381228669433939793464357484350276549975208686778594644420026103742256946843249910774816227113354923539933217563489950555104589202554713352263020111530716888917819520339737690357308261622980951534684991840202859984869712892892239141756252277430937886738881996771080147445410272938947061294178392301438819956947795539940433827913212756666332943009775475701914578705703916156436662432161 c = 5724500982804393999552325992634045287952804319750892943470915970483096772331551016916840383945269998524761532882411398692955440900351993530895920241101091918876067020996223165561345416503911263094097500885104850313790954974285883830265883951377056590933470243828132977718861754767642606894660459919704238136774273318467087409260763141245595380917501542229644505850343679013926414725687233193424516852921591707704514884213118566638296775961963799700542015369513133068927399421907223126861526282761409972982821215039263330243890963476417099153704260378890644297771730781222451447236238246395881031433918137098089530325766260576207689592620432966551477624532170121304029721231233790374192012764855164589022421648544518425385200094885713570919714631967210149469074074462611116405014013224660911261571843297746613484477218466538991573759885491965661063156805466483257274481271612649728798486179280969505996944359268315985465229137237546375405105660181489587704128670445623442389570543693177429900841406620324743316472579871371203563098020011949005568574852024281173097996529 E = EllipticCurve(QQ,[0,1,0,78,-16]) P = E(1,8) k = 1 p1 = 0 # 17922287659013798442573402576339735849131128752056341575054197930940787246564949598938335376226031527888079106524104711777865485173232825060793232006924673971381527349154104858168561572160671487344179035618322434925270004055702274152607679042184080640691186862346789874863888075906696781653068925076057856953267732589112379785385330133335551948122941721689924982720304114154248001316403957518439002843731516224614663616879830159618638468356727817020281211416957107830839823313351269768071723444073187217264382241 while True: Q = k*P if is_prime(Q[0].numerator()): if N%Q[0].numerator() == 0: p1 = Q[0].numerator() break k+=1 # sys.stdout.write(k) q1 = N // p1 assert N == q1*p1 e = 0x10001 phi = (q1-1) * (p1-1) d = inverse_mod(e, phi) print(long_to_bytes(pow(c, d, N)))" /><link rel="canonical" href="http://susanou.github.io/Writeups/posts/UnionCTF/" /><meta property="og:url" content="http://susanou.github.io/Writeups/posts/UnionCTF/" /><meta property="og:site_name" content="Writeups" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-20T23:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Union CTF" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-04-02T05:24:17+02:00","datePublished":"2021-02-20T23:00:00+01:00","description":"HumanServer Source Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 import os, random, hashlib, textwrap, json from Crypto.Cipher import AES from Crypto.Util.Padding import pad, unpad from Crypto.Util.number import getPrime, long_to_bytes from fastecdsa.curve import secp256k1 from fastecdsa.point import Point FLAG = b&#39;union{XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX}&#39; CURVE = secp256k1 ORDER = CURVE.q G = CURVE.G print(ORDER) class EllipticCurveKeyExchange(): def __init__(self): self.private = random.randint(0,ORDER) self.public = self.get_public_key() self.recieved = None self.nonce = None self.key = None def get_public_key(self): A = G * self.private return A def send_public(self): return print(json.dumps({&quot;Px&quot; : self.public.x, &quot;Py&quot; : self.public.y})) def receive_public(self, data): &quot;&quot;&quot; Remember to include the nonce for ultra-secure key exchange! &quot;&quot;&quot; Px = int(data[&quot;Px&quot;]) Py = int(data[&quot;Py&quot;]) self.recieved = Point(Px, Py, curve=secp256k1) self.nonce = int(data[&#39;nonce&#39;]) def get_shared_secret(self): &quot;&quot;&quot; Generates the ultra secure secret with added nonce randomness &quot;&quot;&quot; assert self.nonce.bit_length() &gt; 64 self.key = (self.recieved * self.private).x ^ self.nonce print(self.key) def check_fingerprint(self, h2: str): &quot;&quot;&quot; If this is failing, remember that you must send the SAME nonce to both Alice and Bob for the shared secret to match &quot;&quot;&quot; h1 = hashlib.sha256(long_to_bytes(self.key)).hexdigest() return h1 == h2 def send_fingerprint(self): return hashlib.sha256(long_to_bytes(self.key)).hexdigest() def print_header(title: str): print(&#39;\\n\\n&#39;+&#39;*&#39;*64+&#39;\\n&#39;+&#39;*&#39;+title.center(62)+&#39;*\\n&#39;+&#39;*&#39;*64+&#39;\\n\\n&#39;) def input_json(prompt: str): data = input(prompt) try: return json.loads(data) except: print({&quot;error&quot;: &quot;Input must be sent as a JSON object&quot;}) exit() def encrypt_flag(shared_secret: int): iv = os.urandom(16) key = hashlib.sha1(long_to_bytes(shared_secret)).digest()[:16] cipher = AES.new(key, AES.MODE_CBC, iv) ciphertext = cipher.encrypt(pad(FLAG, 16)) data = {} data[&#39;iv&#39;] = iv.hex() data[&#39;encrypted_flag&#39;] = ciphertext.hex() return print(json.dumps(data)) Alice = EllipticCurveKeyExchange() Bob = EllipticCurveKeyExchange() print_header(&#39;Welcome!&#39;) message = &quot;Hello! Thanks so much for jumping in to help. Ever since everyone left WhatsApp, we&#39;ve had a hard time keeping up with communications. We&#39;re hoping by outsourcing the message exchange to some CTF players we&#39;ll keep the load down on our servers... All messages are end-to-end encrypted so there&#39;s no privacy issues at all, we&#39;ve even rolling out our new ultra-secure key exchange with enhanced randomness! Again, we really appreciate the help, feel free to add this experience to your CV!&quot; welcome = textwrap.fill(message, width=64) print(welcome) print_header(&#39;Alice sends public key&#39;) Alice.send_public() print_header(&quot;Please forward Alice&#39;s key to Bob&quot;) alice_to_bob = input_json(&#39;Send to Bob: &#39;) Bob.receive_public(alice_to_bob) print_header(&#39;Bob sends public key&#39;) Bob.send_public() print_header(&quot;Please forward Bob&#39;s key to Alice&quot;) bob_to_alice = input_json(&#39;Send to Alice: &#39;) Alice.receive_public(bob_to_alice) Alice.get_shared_secret() Bob.get_shared_secret() print_header(&#39;Key verification in progress&#39;) alice_happy = Alice.check_fingerprint(Bob.send_fingerprint()) bob_happy = Bob.check_fingerprint(Alice.send_fingerprint()) if not alice_happy or not bob_happy: print({&quot;error&quot;: &quot;Alice and Bob panicked: Potential MITM attack in progress!!&quot;}) exit() print_header(&#39;Alice sends encrypted flag to Bob&#39;) encrypt_flag(Alice.key) Solution Here we are taking the role of an attacker in between Alice and Bob and we can modify the parameters that they send each other. The curve looks secure as well so we can’t really attack that. The interesting portion is the nonce that they use: 1 2 3 4 5 6 7 8 def get_shared_secret(self): &quot;&quot;&quot; Generates the ultra secure secret with added nonce randomness &quot;&quot;&quot; assert self.nonce.bit_length() &gt; 64 self.key = (self.recieved * self.private).x ^ self.nonce print(self.key) We can see here that they XOR the nonce with the shared key and check that they have the same shared key afterwards. To exploit that I went with the following approach: Use the generator of the curve as your key Send the point that was generated by Alice as the nonce to Bob and vice versa This means that we get the following [(a * G) \\oplus B = A \\oplus B] So now their shared key is basically A ^ B and we can then decrypt the flag with that Solution Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 import os, random, hashlib, textwrap, json from Crypto.Cipher import AES from Crypto.Util.Padding import pad, unpad from Crypto.Util.number import getPrime, long_to_bytes from pwn import * from fastecdsa.curve import secp256k1 from fastecdsa.point import Point r = remote(&#39;134.122.111.232&#39;, 54321, level=&#39;debug&#39;) def json_recv(): line = r.recvuntil(&quot;}&quot;) return json.loads(line.decode()) def json_send(hsh): request = json.dumps(hsh).encode() r.sendline(request) CURVE = secp256k1 ORDER = CURVE.q G = CURVE.G def get_public_key(private): A = G * private return A def get_nonce(private, received): r = Point(int(received[&quot;Px&quot;]), int(received[&quot;Py&quot;]), curve=secp256k1) return (r * private).x def decrypt_flag(shared_secret: int, iv: str, ciphertext: str): key = hashlib.sha1(long_to_bytes(shared_secret)).digest()[:16] cipher = AES.new(key, AES.MODE_CBC, bytes.fromhex(iv)) plaintext = cipher.decrypt(bytes.fromhex(ciphertext)) return unpad(plaintext, 16).decode() mykey = get_public_key(1) r.recvuntil(&quot;Alice sends public key&quot;) r.recv() Alice = json_recv() print(Alice) r.recvuntil(&quot;Send to Bob: &quot;) to_bob = { &quot;Px&quot;: mykey.x, &quot;Py&quot;: mykey.y, &quot;nonce&quot;: get_nonce(1, Alice) } json_send(to_bob) r.recvuntil(&quot;Bob sends public key&quot;) r.recv() Bob = json_recv() print(Bob) r.recvuntil(&quot;Send to Alice: &quot;) to_alice = { &quot;Px&quot;: mykey.x, &quot;Py&quot;: mykey.y, &quot;nonce&quot;: get_nonce(1, Bob) } json_send(to_alice) r.recvuntil(&quot;Alice sends encrypted flag to Bob&quot;) print(r.recvuntil(&quot;\\n\\n&quot;)) flag = json_recv() print(flag) shared = Alice[&quot;Px&quot;] ^ Bob[&quot;Px&quot;] print(decrypt_flag(shared, flag[&quot;iv&quot;], flag[&quot;encrypted_flag&quot;])) Mordel Primes Source Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 from Crypto.Util.number import bytes_to_long from secrets import k, FLAG assert k &lt; 2^128 assert FLAG.startswith(b&#39;union{&#39;) E = EllipticCurve(QQ,[0,1,0,78,-16]) P = E(1,8) Q = k*P R = (k+1)*P p = Q[0].numerator() q = R[0].numerator() assert is_prime(p) assert is_prime(q) e = 0x10001 N = p*q m = bytes_to_long(FLAG) c = pow(m,e,N) print(f&#39;N = {N}&#39;) print(f&#39;c = {c}&#39;) Solution Basically here the hint that was given weired me out. It said more or less that it could generate any prime number over the real numbers. This may be true but the way they are generated in the code above doesn’t guarantee a prime. So my guess was that k was small enough to brute force since they probably took only the first primes that worked and thats it. I brute forced this using SAGE and got the key k used pretty fast. Solution Code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 import sys from Crypto.Util.number import bytes_to_long, long_to_bytes N = 5766655232619116707100300967885753418146107012385091223647868658490220759057780928028480463319202968587922648810849492353260432268633862603886585796452077987022107158189728686203729104591090970460014498552122526631361162547166873599979607915485144034921458475288775124782641916030643521973787176170306963637370313115151225986951445919112900996709332382715307195702225692083801566649385695837056673372362114813257496330084467265988611009917735012603399494099393876040942830547181089862217042482330353171767145579181573964386356108368535032006591008562456350857902266767781457374500922664326761246791942069022937125224604306624131848290329098431374262949684569694816299414596732546870156381228669433939793464357484350276549975208686778594644420026103742256946843249910774816227113354923539933217563489950555104589202554713352263020111530716888917819520339737690357308261622980951534684991840202859984869712892892239141756252277430937886738881996771080147445410272938947061294178392301438819956947795539940433827913212756666332943009775475701914578705703916156436662432161 c = 5724500982804393999552325992634045287952804319750892943470915970483096772331551016916840383945269998524761532882411398692955440900351993530895920241101091918876067020996223165561345416503911263094097500885104850313790954974285883830265883951377056590933470243828132977718861754767642606894660459919704238136774273318467087409260763141245595380917501542229644505850343679013926414725687233193424516852921591707704514884213118566638296775961963799700542015369513133068927399421907223126861526282761409972982821215039263330243890963476417099153704260378890644297771730781222451447236238246395881031433918137098089530325766260576207689592620432966551477624532170121304029721231233790374192012764855164589022421648544518425385200094885713570919714631967210149469074074462611116405014013224660911261571843297746613484477218466538991573759885491965661063156805466483257274481271612649728798486179280969505996944359268315985465229137237546375405105660181489587704128670445623442389570543693177429900841406620324743316472579871371203563098020011949005568574852024281173097996529 E = EllipticCurve(QQ,[0,1,0,78,-16]) P = E(1,8) k = 1 p1 = 0 # 17922287659013798442573402576339735849131128752056341575054197930940787246564949598938335376226031527888079106524104711777865485173232825060793232006924673971381527349154104858168561572160671487344179035618322434925270004055702274152607679042184080640691186862346789874863888075906696781653068925076057856953267732589112379785385330133335551948122941721689924982720304114154248001316403957518439002843731516224614663616879830159618638468356727817020281211416957107830839823313351269768071723444073187217264382241 while True: Q = k*P if is_prime(Q[0].numerator()): if N%Q[0].numerator() == 0: p1 = Q[0].numerator() break k+=1 # sys.stdout.write(k) q1 = N // p1 assert N == q1*p1 e = 0x10001 phi = (q1-1) * (p1-1) d = inverse_mod(e, phi) print(long_to_bytes(pow(c, d, N)))","headline":"Union CTF","mainEntityOfPage":{"@type":"WebPage","@id":"http://susanou.github.io/Writeups/posts/UnionCTF/"},"url":"http://susanou.github.io/Writeups/posts/UnionCTF/"}</script><title>Union CTF | Writeups</title><link rel="apple-touch-icon" sizes="180x180" href="/Writeups/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/Writeups/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/Writeups/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/Writeups/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/Writeups/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Writeups"><meta name="application-name" content="Writeups"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/Writeups/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/Writeups/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/Writeups/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script defer src="/Writeups/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/Writeups/" alt="avatar" class="mx-auto"> <img src="/Writeups/assets/img/sample/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/Writeups/">Writeups</a></div><div class="site-subtitle font-italic">Student by day Hacker by night</div></div><ul class="w-100"><li class="nav-item"> <a href="/Writeups/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/Writeups/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/Writeups/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/Writeups/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/Writeups/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Susanou" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://app.hackthebox.eu/profile/337512" aria-label="htb" target="_blank" rel="noopener"> <i class="fas fa-cube"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cam.hochberg','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/Writeups/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/cam-hochberg/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/Writeups/"> Posts </a> </span> <span>Union CTF</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Union CTF</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Cameron Hochberg </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Feb 20, 2021, 11:00 PM +0100" prep="on" > Feb 20, 2021 <i class="unloaded">2021-02-20T23:00:00+01:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Apr 1, 2021, 11:24 PM -0400" prefix="Updated " > Apr 1, 2021 <i class="unloaded">2021-04-02T05:24:17+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1211 words">6 min</span></div></div><div class="post-content"><h1 id="humanserver">HumanServer</h1><h2 id="source-code">Source Code</h2><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">random</span><span class="p">,</span> <span class="n">hashlib</span><span class="p">,</span> <span class="n">textwrap</span><span class="p">,</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="n">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">unpad</span>
<span class="kn">from</span> <span class="n">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">getPrime</span><span class="p">,</span> <span class="n">long_to_bytes</span>


<span class="kn">from</span> <span class="n">fastecdsa.curve</span> <span class="kn">import</span> <span class="n">secp256k1</span>
<span class="kn">from</span> <span class="n">fastecdsa.point</span> <span class="kn">import</span> <span class="n">Point</span>

<span class="n">FLAG</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">union{XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX}</span><span class="sh">'</span>

<span class="n">CURVE</span> <span class="o">=</span> <span class="n">secp256k1</span>
<span class="n">ORDER</span> <span class="o">=</span> <span class="n">CURVE</span><span class="p">.</span><span class="n">q</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">CURVE</span><span class="p">.</span><span class="n">G</span>

<span class="nf">print</span><span class="p">(</span><span class="n">ORDER</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">EllipticCurveKeyExchange</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ORDER</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">public</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_public_key</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">recieved</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">nonce</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">get_public_key</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">private</span>
        <span class="k">return</span> <span class="n">A</span>

    <span class="k">def</span> <span class="nf">send_public</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">({</span><span class="sh">"</span><span class="s">Px</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">public</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="sh">"</span><span class="s">Py</span><span class="sh">"</span> <span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">public</span><span class="p">.</span><span class="n">y</span><span class="p">}))</span>

    <span class="k">def</span> <span class="nf">receive_public</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Remember to include the nonce for ultra-secure key exchange!
        </span><span class="sh">"""</span>
        <span class="n">Px</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">Px</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">Py</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">Py</span><span class="sh">"</span><span class="p">])</span>
        <span class="n">self</span><span class="p">.</span><span class="n">recieved</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span><span class="n">Px</span><span class="p">,</span> <span class="n">Py</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="n">secp256k1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">nonce</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">nonce</span><span class="sh">'</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_shared_secret</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Generates the ultra secure secret with added nonce randomness
        </span><span class="sh">"""</span>
        <span class="k">assert</span> <span class="n">self</span><span class="p">.</span><span class="n">nonce</span><span class="p">.</span><span class="nf">bit_length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">64</span>
        <span class="n">self</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">recieved</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">private</span><span class="p">).</span><span class="n">x</span> <span class="o">^</span> <span class="n">self</span><span class="p">.</span><span class="n">nonce</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_fingerprint</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">h2</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        If this is failing, remember that you must send the SAME
        nonce to both Alice and Bob for the shared secret to match
        </span><span class="sh">"""</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="nf">long_to_bytes</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">key</span><span class="p">)).</span><span class="nf">hexdigest</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">h1</span> <span class="o">==</span> <span class="n">h2</span>

    <span class="k">def</span> <span class="nf">send_fingerprint</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha256</span><span class="p">(</span><span class="nf">long_to_bytes</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">key</span><span class="p">)).</span><span class="nf">hexdigest</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">print_header</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="se">\n\n</span><span class="sh">'</span><span class="o">+</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="o">*</span><span class="mi">64</span><span class="o">+</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="o">+</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="o">+</span><span class="n">title</span><span class="p">.</span><span class="nf">center</span><span class="p">(</span><span class="mi">62</span><span class="p">)</span><span class="o">+</span><span class="sh">'</span><span class="s">*</span><span class="se">\n</span><span class="sh">'</span><span class="o">+</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="o">*</span><span class="mi">64</span><span class="o">+</span><span class="sh">'</span><span class="se">\n\n</span><span class="sh">'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">input_json</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Input must be sent as a JSON object</span><span class="sh">"</span><span class="p">})</span>
        <span class="nf">exit</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">encrypt_flag</span><span class="p">(</span><span class="n">shared_secret</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha1</span><span class="p">(</span><span class="nf">long_to_bytes</span><span class="p">(</span><span class="n">shared_secret</span><span class="p">)).</span><span class="nf">digest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
    <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nf">pad</span><span class="p">(</span><span class="n">FLAG</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">iv</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">iv</span><span class="p">.</span><span class="nf">hex</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">encrypted_flag</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ciphertext</span><span class="p">.</span><span class="nf">hex</span><span class="p">()</span>
    <span class="k">return</span> <span class="nf">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>


<span class="n">Alice</span> <span class="o">=</span> <span class="nc">EllipticCurveKeyExchange</span><span class="p">()</span>
<span class="n">Bob</span> <span class="o">=</span> <span class="nc">EllipticCurveKeyExchange</span><span class="p">()</span>

<span class="nf">print_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Welcome!</span><span class="sh">'</span><span class="p">)</span> 
<span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Hello! Thanks so much for jumping in to help. Ever since everyone left WhatsApp, we</span><span class="sh">'</span><span class="s">ve had a hard time keeping up with communications. We</span><span class="sh">'</span><span class="s">re hoping by outsourcing the message exchange to some CTF players we</span><span class="sh">'</span><span class="s">ll keep the load down on our servers... All messages are end-to-end encrypted so there</span><span class="sh">'</span><span class="s">s no privacy issues at all, we</span><span class="sh">'</span><span class="s">ve even rolling out our new ultra-secure key exchange with enhanced randomness! Again, we really appreciate the help, feel free to add this experience to your CV!</span><span class="sh">"</span>
<span class="n">welcome</span> <span class="o">=</span> <span class="n">textwrap</span><span class="p">.</span><span class="nf">fill</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>          
<span class="nf">print</span><span class="p">(</span><span class="n">welcome</span><span class="p">)</span>

<span class="nf">print_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Alice sends public key</span><span class="sh">'</span><span class="p">)</span>
<span class="n">Alice</span><span class="p">.</span><span class="nf">send_public</span><span class="p">()</span>

<span class="nf">print_header</span><span class="p">(</span><span class="sh">"</span><span class="s">Please forward Alice</span><span class="sh">'</span><span class="s">s key to Bob</span><span class="sh">"</span><span class="p">)</span>
<span class="n">alice_to_bob</span> <span class="o">=</span> <span class="nf">input_json</span><span class="p">(</span><span class="sh">'</span><span class="s">Send to Bob: </span><span class="sh">'</span><span class="p">)</span>
<span class="n">Bob</span><span class="p">.</span><span class="nf">receive_public</span><span class="p">(</span><span class="n">alice_to_bob</span><span class="p">)</span>

<span class="nf">print_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Bob sends public key</span><span class="sh">'</span><span class="p">)</span>
<span class="n">Bob</span><span class="p">.</span><span class="nf">send_public</span><span class="p">()</span>

<span class="nf">print_header</span><span class="p">(</span><span class="sh">"</span><span class="s">Please forward Bob</span><span class="sh">'</span><span class="s">s key to Alice</span><span class="sh">"</span><span class="p">)</span>
<span class="n">bob_to_alice</span> <span class="o">=</span> <span class="nf">input_json</span><span class="p">(</span><span class="sh">'</span><span class="s">Send to Alice: </span><span class="sh">'</span><span class="p">)</span>
<span class="n">Alice</span><span class="p">.</span><span class="nf">receive_public</span><span class="p">(</span><span class="n">bob_to_alice</span><span class="p">)</span>
            
<span class="n">Alice</span><span class="p">.</span><span class="nf">get_shared_secret</span><span class="p">()</span>
<span class="n">Bob</span><span class="p">.</span><span class="nf">get_shared_secret</span><span class="p">()</span>

<span class="nf">print_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Key verification in progress</span><span class="sh">'</span><span class="p">)</span>
<span class="n">alice_happy</span> <span class="o">=</span> <span class="n">Alice</span><span class="p">.</span><span class="nf">check_fingerprint</span><span class="p">(</span><span class="n">Bob</span><span class="p">.</span><span class="nf">send_fingerprint</span><span class="p">())</span>
<span class="n">bob_happy</span> <span class="o">=</span> <span class="n">Bob</span><span class="p">.</span><span class="nf">check_fingerprint</span><span class="p">(</span><span class="n">Alice</span><span class="p">.</span><span class="nf">send_fingerprint</span><span class="p">())</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">alice_happy</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">bob_happy</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Alice and Bob panicked: Potential MITM attack in progress!!</span><span class="sh">"</span><span class="p">})</span>
    <span class="nf">exit</span><span class="p">()</span>

<span class="nf">print_header</span><span class="p">(</span><span class="sh">'</span><span class="s">Alice sends encrypted flag to Bob</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">encrypt_flag</span><span class="p">(</span><span class="n">Alice</span><span class="p">.</span><span class="n">key</span><span class="p">)</span>

</pre></table></code></div></div><h2 id="solution">Solution</h2><p>Here we are taking the role of an attacker in between Alice and Bob and we can modify the parameters that they send each other. The curve looks secure as well so we can’t really attack that.</p><p>The interesting portion is the nonce that they use:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>    <span class="k">def</span> <span class="nf">get_shared_secret</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Generates the ultra secure secret with added nonce randomness
        </span><span class="sh">"""</span>
        <span class="k">assert</span> <span class="n">self</span><span class="p">.</span><span class="n">nonce</span><span class="p">.</span><span class="nf">bit_length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">64</span>
        <span class="n">self</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">recieved</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">private</span><span class="p">).</span><span class="n">x</span> <span class="o">^</span> <span class="n">self</span><span class="p">.</span><span class="n">nonce</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">key</span><span class="p">)</span>

</pre></table></code></div></div><p>We can see here that they XOR the nonce with the shared key and check that they have the same shared key afterwards. To exploit that I went with the following approach:</p><ul><li>Use the generator of the curve as your key<li>Send the point that was generated by Alice as the nonce to Bob and vice versa</ul><p>This means that we get the following</p>\[(a * G) \oplus B = A \oplus B\]<p>So now their shared key is basically <code class="language-plaintext highlighter-rouge">A ^ B</code> and we can then decrypt the flag with that</p><h2 id="solution-code">Solution Code</h2><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">random</span><span class="p">,</span> <span class="n">hashlib</span><span class="p">,</span> <span class="n">textwrap</span><span class="p">,</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="n">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">unpad</span>
<span class="kn">from</span> <span class="n">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">getPrime</span><span class="p">,</span> <span class="n">long_to_bytes</span>

<span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="n">fastecdsa.curve</span> <span class="kn">import</span> <span class="n">secp256k1</span>
<span class="kn">from</span> <span class="n">fastecdsa.point</span> <span class="kn">import</span> <span class="n">Point</span>

<span class="n">r</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">'</span><span class="s">134.122.111.232</span><span class="sh">'</span><span class="p">,</span> <span class="mi">54321</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="sh">'</span><span class="s">debug</span><span class="sh">'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">json_recv</span><span class="p">():</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sh">"</span><span class="s">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="nf">decode</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">json_send</span><span class="p">(</span><span class="n">hsh</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">dumps</span><span class="p">(</span><span class="n">hsh</span><span class="p">).</span><span class="nf">encode</span><span class="p">()</span>
    <span class="n">r</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<span class="n">CURVE</span> <span class="o">=</span> <span class="n">secp256k1</span>
<span class="n">ORDER</span> <span class="o">=</span> <span class="n">CURVE</span><span class="p">.</span><span class="n">q</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">CURVE</span><span class="p">.</span><span class="n">G</span>

<span class="k">def</span> <span class="nf">get_public_key</span><span class="p">(</span><span class="n">private</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="n">private</span>
    <span class="k">return</span> <span class="n">A</span>

<span class="k">def</span> <span class="nf">get_nonce</span><span class="p">(</span><span class="n">private</span><span class="p">,</span> <span class="n">received</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nc">Point</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">received</span><span class="p">[</span><span class="sh">"</span><span class="s">Px</span><span class="sh">"</span><span class="p">]),</span> <span class="nf">int</span><span class="p">(</span><span class="n">received</span><span class="p">[</span><span class="sh">"</span><span class="s">Py</span><span class="sh">"</span><span class="p">]),</span> <span class="n">curve</span><span class="o">=</span><span class="n">secp256k1</span><span class="p">)</span>
    <span class="nf">return </span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">private</span><span class="p">).</span><span class="n">x</span>

<span class="k">def</span> <span class="nf">decrypt_flag</span><span class="p">(</span><span class="n">shared_secret</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">iv</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="nf">sha1</span><span class="p">(</span><span class="nf">long_to_bytes</span><span class="p">(</span><span class="n">shared_secret</span><span class="p">)).</span><span class="nf">digest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">.</span><span class="nf">fromhex</span><span class="p">(</span><span class="n">iv</span><span class="p">))</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="nb">bytes</span><span class="p">.</span><span class="nf">fromhex</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">))</span>

    <span class="k">return</span> <span class="nf">unpad</span><span class="p">(</span><span class="n">plaintext</span><span class="p">,</span> <span class="mi">16</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>


<span class="n">mykey</span> <span class="o">=</span> <span class="nf">get_public_key</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice sends public key</span><span class="sh">"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>

<span class="n">Alice</span> <span class="o">=</span> <span class="nf">json_recv</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="n">Alice</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sh">"</span><span class="s">Send to Bob: </span><span class="sh">"</span><span class="p">)</span>

<span class="n">to_bob</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">Px</span><span class="sh">"</span><span class="p">:</span> <span class="n">mykey</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">Py</span><span class="sh">"</span><span class="p">:</span> <span class="n">mykey</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="nf">get_nonce</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Alice</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">json_send</span><span class="p">(</span><span class="n">to_bob</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sh">"</span><span class="s">Bob sends public key</span><span class="sh">"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>

<span class="n">Bob</span> <span class="o">=</span> <span class="nf">json_recv</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="n">Bob</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sh">"</span><span class="s">Send to Alice: </span><span class="sh">"</span><span class="p">)</span>

<span class="n">to_alice</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">Px</span><span class="sh">"</span><span class="p">:</span> <span class="n">mykey</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">Py</span><span class="sh">"</span><span class="p">:</span> <span class="n">mykey</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">nonce</span><span class="sh">"</span><span class="p">:</span> <span class="nf">get_nonce</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Bob</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">json_send</span><span class="p">(</span><span class="n">to_alice</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sh">"</span><span class="s">Alice sends encrypted flag to Bob</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="sh">"</span><span class="se">\n\n</span><span class="sh">"</span><span class="p">))</span>

<span class="n">flag</span> <span class="o">=</span> <span class="nf">json_recv</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

<span class="n">shared</span> <span class="o">=</span> <span class="n">Alice</span><span class="p">[</span><span class="sh">"</span><span class="s">Px</span><span class="sh">"</span><span class="p">]</span> <span class="o">^</span> <span class="n">Bob</span><span class="p">[</span><span class="sh">"</span><span class="s">Px</span><span class="sh">"</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">decrypt_flag</span><span class="p">(</span><span class="n">shared</span><span class="p">,</span> <span class="n">flag</span><span class="p">[</span><span class="sh">"</span><span class="s">iv</span><span class="sh">"</span><span class="p">],</span> <span class="n">flag</span><span class="p">[</span><span class="sh">"</span><span class="s">encrypted_flag</span><span class="sh">"</span><span class="p">]))</span>
</pre></table></code></div></div><h1 id="mordel-primes">Mordel Primes</h1><h2 id="source-code-1">Source Code</h2><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span>
<span class="kn">from</span> <span class="n">secrets</span> <span class="kn">import</span> <span class="n">k</span><span class="p">,</span> <span class="n">FLAG</span>
 
<span class="k">assert</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">^</span><span class="mi">128</span>
<span class="k">assert</span> <span class="n">FLAG</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">union{</span><span class="sh">'</span><span class="p">)</span>
 
<span class="n">E</span> <span class="o">=</span> <span class="nc">EllipticCurve</span><span class="p">(</span><span class="n">QQ</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">78</span><span class="p">,</span><span class="o">-</span><span class="mi">16</span><span class="p">])</span>
<span class="n">P</span> <span class="o">=</span> <span class="nc">E</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">P</span>
<span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">P</span>
 
<span class="n">p</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">numerator</span><span class="p">()</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">numerator</span><span class="p">()</span>
 
<span class="k">assert</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">assert</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
 
<span class="n">e</span> <span class="o">=</span> <span class="mh">0x10001</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span>
<span class="n">m</span> <span class="o">=</span> <span class="nf">bytes_to_long</span><span class="p">(</span><span class="n">FLAG</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="nf">pow</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
 
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">N = </span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">c = </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
</pre></table></code></div></div><h2 id="solution-1">Solution</h2><p>Basically here the hint that was given weired me out. It said more or less that it could generate any prime number over the real numbers. This may be true but the way they are generated in the code above doesn’t guarantee a prime. So my guess was that k was small enough to brute force since they probably took only the first primes that worked and thats it.</p><p>I brute forced this using SAGE and got the key <code class="language-plaintext highlighter-rouge">k</code> used pretty fast.</p><h2 id="solution-code-1">Solution Code</h2><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">sys</span>

<span class="kn">from</span> <span class="n">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">5766655232619116707100300967885753418146107012385091223647868658490220759057780928028480463319202968587922648810849492353260432268633862603886585796452077987022107158189728686203729104591090970460014498552122526631361162547166873599979607915485144034921458475288775124782641916030643521973787176170306963637370313115151225986951445919112900996709332382715307195702225692083801566649385695837056673372362114813257496330084467265988611009917735012603399494099393876040942830547181089862217042482330353171767145579181573964386356108368535032006591008562456350857902266767781457374500922664326761246791942069022937125224604306624131848290329098431374262949684569694816299414596732546870156381228669433939793464357484350276549975208686778594644420026103742256946843249910774816227113354923539933217563489950555104589202554713352263020111530716888917819520339737690357308261622980951534684991840202859984869712892892239141756252277430937886738881996771080147445410272938947061294178392301438819956947795539940433827913212756666332943009775475701914578705703916156436662432161</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">5724500982804393999552325992634045287952804319750892943470915970483096772331551016916840383945269998524761532882411398692955440900351993530895920241101091918876067020996223165561345416503911263094097500885104850313790954974285883830265883951377056590933470243828132977718861754767642606894660459919704238136774273318467087409260763141245595380917501542229644505850343679013926414725687233193424516852921591707704514884213118566638296775961963799700542015369513133068927399421907223126861526282761409972982821215039263330243890963476417099153704260378890644297771730781222451447236238246395881031433918137098089530325766260576207689592620432966551477624532170121304029721231233790374192012764855164589022421648544518425385200094885713570919714631967210149469074074462611116405014013224660911261571843297746613484477218466538991573759885491965661063156805466483257274481271612649728798486179280969505996944359268315985465229137237546375405105660181489587704128670445623442389570543693177429900841406620324743316472579871371203563098020011949005568574852024281173097996529</span>

<span class="n">E</span> <span class="o">=</span> <span class="nc">EllipticCurve</span><span class="p">(</span><span class="n">QQ</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">78</span><span class="p">,</span><span class="o">-</span><span class="mi">16</span><span class="p">])</span>
<span class="n">P</span> <span class="o">=</span> <span class="nc">E</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>

<span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">p1</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 17922287659013798442573402576339735849131128752056341575054197930940787246564949598938335376226031527888079106524104711777865485173232825060793232006924673971381527349154104858168561572160671487344179035618322434925270004055702274152607679042184080640691186862346789874863888075906696781653068925076057856953267732589112379785385330133335551948122941721689924982720304114154248001316403957518439002843731516224614663616879830159618638468356727817020281211416957107830839823313351269768071723444073187217264382241
</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">P</span>

    <span class="k">if</span> <span class="nf">is_prime</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">numerator</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">%</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">numerator</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">numerator</span><span class="p">()</span>
            <span class="k">break</span>
    <span class="n">k</span><span class="o">+=</span><span class="mi">1</span>
<span class="c1">#    sys.stdout.write(k)
</span>
<span class="n">q1</span> <span class="o">=</span> <span class="n">N</span> <span class="o">//</span> <span class="n">p1</span>
<span class="k">assert</span> <span class="n">N</span> <span class="o">==</span> <span class="n">q1</span><span class="o">*</span><span class="n">p1</span>

<span class="n">e</span> <span class="o">=</span> <span class="mh">0x10001</span>

<span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">q1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="nf">inverse_mod</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">long_to_bytes</span><span class="p">(</span><span class="nf">pow</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">N</span><span class="p">)))</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/Writeups/categories/union-ctf/'>Union CTF</a>, <a href='/Writeups/categories/cryptography/'>Cryptography</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/Writeups/tags/crypto/" class="post-tag no-text-decoration" >crypto</a> <a href="/Writeups/tags/ecc/" class="post-tag no-text-decoration" >ECC</a> <a href="/Writeups/tags/prime-numbers/" class="post-tag no-text-decoration" >prime numbers</a> <a href="/Writeups/tags/dh/" class="post-tag no-text-decoration" >DH</a> <a href="/Writeups/tags/mitm/" class="post-tag no-text-decoration" >MITM</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Union CTF - Writeups&url=http://susanou.github.io/Writeups/posts/UnionCTF/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Union CTF - Writeups&u=http://susanou.github.io/Writeups/posts/UnionCTF/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Union CTF - Writeups&url=http://susanou.github.io/Writeups/posts/UnionCTF/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/Writeups/posts/cycling/">Cycling</a><li><a href="/Writeups/posts/mlsteal/">MLSteal</a><li><a href="/Writeups/posts/pythia/">Pythia</a><li><a href="/Writeups/posts/ChunkNoris/">Chunk Norris</a><li><a href="/Writeups/posts/Admirer/">Admirer</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/Writeups/tags/crypto/">crypto</a> <a class="post-tag" href="/Writeups/tags/rsa/">RSA</a> <a class="post-tag" href="/Writeups/tags/easy/">easy</a> <a class="post-tag" href="/Writeups/tags/web/">web</a> <a class="post-tag" href="/Writeups/tags/aes/">AES</a> <a class="post-tag" href="/Writeups/tags/linux/">linux</a> <a class="post-tag" href="/Writeups/tags/misc/">misc</a> <a class="post-tag" href="/Writeups/tags/mitm/">MITM</a> <a class="post-tag" href="/Writeups/tags/sqli/">SQLi</a> <a class="post-tag" href="/Writeups/tags/crt/">CRT</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/Writeups/posts/RookieMistake/"><div class="card-body"> <span class="timeago small" > Jan 20, 2021 <i class="unloaded">2021-01-20T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Rookie Mistake</h3><div class="text-muted small"><p></p></div></div></a></div><div class="card"> <a href="/Writeups/posts/static-client/"><div class="card-body"> <span class="timeago small" > Jun 1, 2021 <i class="unloaded">2021-06-01T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Static Client</h3><div class="text-muted small"><p></p></div></div></a></div><div class="card"> <a href="/Writeups/posts/static-client2/"><div class="card-body"> <span class="timeago small" > Jul 28, 2021 <i class="unloaded">2021-07-28T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Static Client 2</h3><div class="text-muted small"><p></p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/Writeups/posts/RookieMistake/" class="btn btn-outline-primary" prompt="Older"><p>Rookie Mistake</p></a> <a href="/Writeups/posts/LINECTF/" class="btn btn-outline-primary" prompt="Newer"><p>LINE CTF</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/Writeups/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//writeups-fukurou.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Union CTF'; this.page.url = 'http://susanou.github.io/Writeups/posts/UnionCTF/'; this.page.identifier = '/posts/UnionCTF/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/Susanou">Cameron Hochberg</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="Susanou" data-description="Support me on Buy me a coffee!" data-message="" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18"></script></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/Writeups/tags/crypto/">crypto</a> <a class="post-tag" href="/Writeups/tags/rsa/">RSA</a> <a class="post-tag" href="/Writeups/tags/easy/">easy</a> <a class="post-tag" href="/Writeups/tags/web/">web</a> <a class="post-tag" href="/Writeups/tags/aes/">AES</a> <a class="post-tag" href="/Writeups/tags/linux/">linux</a> <a class="post-tag" href="/Writeups/tags/misc/">misc</a> <a class="post-tag" href="/Writeups/tags/mitm/">MITM</a> <a class="post-tag" href="/Writeups/tags/sqli/">SQLi</a> <a class="post-tag" href="/Writeups/tags/crt/">CRT</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/Writeups/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://susanou.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
